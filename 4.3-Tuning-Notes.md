# DRAFT - many elements not merged yet!

## [Betaflight 4.3](https://github.com/betaflight/betaflight/releases) has been a long wait - but it’s been worth it!  Your quad should fly smoother, quieter and better than ever!  4.3 brings:

- [Presets](4.3-Tuning-Notes#Presets) - A fantastic, completely new preset system!  Whether a whoop, a twig, a 5" racer, a freestyle setup, or an X-class, we now provide a simple way apply a great tune for your quad, out of the box.
- [New tuning sliders](4.3-Tuning-Notes#New-tuning-sliders) - Whether you need to tweak the tune or do it from scratch, we now have simpler, more comprehensive, firmware based tuning sliders in the Configurator.  Slider positions are stored with the quad, and can be modified via the OSD as well  We now have sliders to balance pitch:roll responsiveness.
- [More accurate loop times](4.3-Tuning-Notes#More-accurate-loop-times) - massive scheduler and DMA code improvements, including EXTI triggered SPI gyro reads, leading to more stable looptimes, smoother filter performance and improved CPU efficiency and faster logging.  
- [Multi dynamic notch](4.3-Tuning-Notes#Multi-dynamic-notch) - Completely rewritten, and much improved, SDFT based multi-dynamic notch.  More than one resonant peak can be tracked at the same time, and more accurately and quickly than before, keeping motors smoother and cooler.
- [PT3 based RC smoothing](4.3-Tuning-Notes#PT3-based-RC-smoothing) - RC smoothing has been completely revised, and is now entirely filter based, using PT3 (third order) smoothing.  Changing the auto smoothing value provides anything from near-zero delay to exceptional cinematic smoothness.
- [RPM crossfading](4.3-Tuning-Notes#RPM-crossfading) - we now can smoothly disable RPM filtering entirely at low RPM.  This greatly reduces filter delay at low throttle.  You’ll hear an immediate difference in the sound of the motors, and get less propwash.
- [Feedforward jitter reduction](4.3-Tuning-Notes#Feedforward-jitter-reduction) - 4.3 introduces feedforward jitter reduction, which delivers a kind of ‘dynamic transition’ effect, allowing users to ditch transition, yet get silky smooth responses to slow stick inputs, and immediate, snappy feedforward responses to quick inputs.  It also attenuates RC link noise during slow movements, especially at high rate Rx links. [race to cinematic purposes](4.3-Tuning-Notes#Quick-settings)
- [Other feedforward improvements](4.3-Tuning-Notes#Other-feedforward-improvements) - To smooth out 'steps' in feedforward arising from irregularities in the RC link data, first order smoothing of feeedforward steps and second order smoothing of the boost component is now active by default.  Most radios will not require packet averaging so this is now off.  The old clip and spike reduction settings aren't needed.
- [AntiGravity improvements](4.3-Tuning-Notes#AntiGravity-improvements) - The timing of the I boost has been optimised to peak when it is most needed, and some P boost applied also.  This provides greater stability during rapid throttle changes.  The default value of 3 should not be increased without careful testing.
- [Dynamic gyro filter expo curve](4.3-Tuning-Notes#Dynamic-gyro-filtering-expo-curve) - improves propwash by raising dynamic gyro filter cutoffs faster as you throttle up
- [Improved dynamic idle](4.3-Improved-dynamic-idle) - The dynamic idle code has been heavily revised, and can now keep RPM at a more stable value, more quickly, than before, using a modified single sided PID controller.  It can now hold RPM above the normal idle value, improving motor startup behaviour and responsiveness for ESCs that are slow to spin up from low RPM, while allowing motor drive to go to zero for enhanced braking when appropriate.
- [Linear and Dynamic mixer options](4.3-Tuning-Notes#Linear-and-Dynamic-mixer-options) - These are alternatives to the standard Betaflight mixer, the dynamic option may result in less aggressive bump responses for level mode or cinematic flights
- [Feedforward in Level and Horizon Modes](4.3-Tuning-Notes#Feedforward-in-Level-and-Horizon-Modes) - Feedforward is now active in horizon and level modes, leading to quicker level mode angle changes, and making Horizon mode as responsive as Acro for flips and other fast moves.
- [Actual Rates as the new Betaflight default](4.3-Tuning-Notes#Actual-Rates-as-the-new-Betaflight-default) - Actual rates provide a simpler and more intuitive way to set your Rates, and are now the default.  Betaflight rates are optional.  *Take care when updating! If you copy and paste your old rates values, be sure to copy and paste the rates type also!*
- [PT2 and PT3 lowpass filtering options](4.3-Tuning-Notes#PT2 -and-PT3-gyro-filter-options) - The old biquad filter option is no longer available, due to overshoot and resonance issues.  Users should change to PT2 if they need second order filtering.
- [CrossfireV3 and Ghost RC link improvements](4.3-Tuning-Notes#CrossfireV3-and-Ghost-RC-link-improvements) - As well as support for the latest Crossfire, ELRS and Ghost protocols, the internal betaflight RC code now supports 12bit or higher RC data in a float data path, handles very low RC Links (down to 16hz) better than before, fully supports high speed links to 1000hz, and better attenuates feedforward glitches when the RC link returns after dropouts.
- [FrSky OSD fix](4.3-Tuning-Notes#Frsky-OSD-fix) - Asizon fixed it!
- [Lua script updates](4.3-Tuning-Notes#Lua-script-updates) - RSSI in your OSD via LUA, and tuning slider control from the radio, amongst lots of other changes



**4.3 should fly really well on defaults, with no modifications, with most quads - but if a preset exists that resembles your build, use it!**

If you're new to 4.3, please read the previous tuning notes for any topic that isn't covered here.

**The [latest 10.8 Betaflight Configurator](https://github.com/betaflight/betaflight-configurator/releases) is mandatory.  Earlier versions are not going to work properly.**

**NOTE 1**: DO NOT paste a whole diff or dump from any prior build into the 4.3 CLI!  See if you can use a Preset, and try to set up the sliders to approximate your old PIDs and filter settings. 

**NOTE 2**: Check all your settings carefully before attempting to arm for the first time.  In particular, check your rates.  This rates calculator can help to [convert from Betaflight to Actual rates](https://www.desmos.com/calculator/hwxfjncflf).  The first few times, arm in a safe place, and fly gently.  

**NOTE 3**: We strongly recommend flying the default antigravity value and only re-tuning if needed [here](4.3-Tuning-Notes#antigravity-improvements).  

**NOTE 4**: We strongly recommend using eRPM based filtering.  Read about [enabling and configuring rpm filtering here.](https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter)


## Quick settings 

These snippets are suggestions for how some of the less common settings might be adjusted to suit a certain type of flying.  The defaults should be fine for fast freestyle and general racing requirements.  I can't say that they will be perfect on your quad, and they do not include PID tuning or filter values, but they might show the kind of ranges for some of these numbers.

**Race** 
```
set iterm_relax_cutoff = 30

set rc_smoothing = ON
set rc_smoothing_auto_factor = 30
set rc_smoothing_auto_factor_throttle = 30
set rc_smoothing_setpoint_cutoff = 0
set rc_smoothing_feedforward_cutoff = 0
set rc_smoothing_throttle_cutoff = 0

set feedforward_transition = 0
set feedforward_averaging = OFF
set feedforward_smooth_factor = 25
set feedforward_jitter_reduction = 7
set feedforward_max_rate_limit = 90
set feedforward_boost = 14

set yaw_lowpass_hz = 100

set throttle_boost = 7
set throttle_boost_cutoff = 25

set dyn_lpf_dterm_curve_expo = 7

set gyro_rpm_notch_q = 350
set gyro_rpm_notch_min = 80
set gyro_rpm_notch_fade_range_hz = 50
set gyro_rpm_notch_harmonics = 3

set dyn_notch_count = 2
set dyn_notch_q = 450
set dyn_notch_min_hz = 200
set dyn_notch_max_hz = 500

set rates_type = ACTUAL
set roll_rc_rate = 20
set pitch_rc_rate = 20
set yaw_rc_rate = 20
set roll_srate = 65
set pitch_srate = 65
set yaw_srate = 65
set roll_expo = 0
set pitch_expo = 0
set yaw_expo = 0

set vbat_sag_compensation = 100
set throttle_limit_type = SCALE
set throttle_limit_percent = 95

set gyro_lowpass_type = PT1
set gyro_lowpass_hz = 500
set dyn_lpf_gyro_min_hz = 500
set dyn_lpf_gyro_max_hz = 1000
set dyn_lpf_gyro_curve_expo = 0

set gyro_lowpass2_type = PT1
set gyro_lowpass2_hz = 500

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 140
set dyn_lpf_dterm_min_hz = 70
set dyn_lpf_dterm_max_hz = 140
set dyn_lpf_dterm_curve_expo = 6

set dterm_lowpass2_type = PT1
set dterm_lowpass2_hz = 150
```
(enable sag compensation, as high as suits you, and D expo also)

**Fast Freestyle** (paste the race settings, then these modifications)
```
set iterm_relax_cutoff = 20
set rc_smoothing_auto_smoothness = 45
set feedforward_jitter_reduction = 10
set feedforward_smooth_factor = 30
set dyn_lpf_dterm_curve_expo = 7

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 150
set dyn_lpf_dterm_min_hz = 75
set dyn_lpf_dterm_max_hz = 150

set roll_rc_rate = 10
set pitch_rc_rate = 10
set yaw_rc_rate = 10
```

**HD** (smoothed FF for HD cameras, strong low turn rate smoothness, low iterm relax to minimise bounce back - paste the race settings, then these modifications)
```
set iterm_relax_cutoff = 10
set rc_smoothing_auto_smoothness = 60
set feedforward_jitter_reduction = 12
set feedforward_smooth_factor = 35
set dyn_lpf_dterm_curve_expo = 7

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 150
set dyn_lpf_dterm_min_hz = 75
set dyn_lpf_dterm_max_hz = 150

set roll_rc_rate = 5
set pitch_rc_rate = 5
set yaw_rc_rate = 5
```

**Cinematic** (For smooth cinematic flying, will feel very 'dull' otherwise)
```
set iterm_relax_cutoff = 5
set rc_smoothing_auto_smoothness = 120
set feedforward_jitter_reduction = 12
set feedforward_smooth_factor = 45
set dyn_lpf_dterm_curve_expo = 7

set throttle_boost = 2
set throttle_boost_cutoff = 10

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 150
set dyn_lpf_dterm_min_hz = 75
set dyn_lpf_dterm_max_hz = 150

set roll_rc_rate = 1
set pitch_rc_rate = 1
set yaw_rc_rate = 1

set iterm_windup = 75 # for larger or ducted quads; 50 for really big ones
```
`
### Settings to minimise bounceback

The following tuning suggestions may help minimise minor random wobbles in HD footage:
- tune for the highest possible D, and avoid setting P too high
- set D_min at about 75% of DMax
- get D close to P, or up to 20% above P
- set TPA to D only, and start it to start just below your cruising throttle value
  (note that you may need more D filtering - check the motor temperatures and don't go too high on D!)
- use about half the default I on pitch and roll
- make sure the ADC is not ticked in the hardware settings of OpenTx!!

For zero throttle instability
- go back to 24kHZ PWM if you've set the ESc to 48kHz
- enable dynamic idle at 4000 RPM or whatever gives a solid spin on arming
- try thrust linear at 25
- try slightly higher overall PIDs


### Settings to minimise bounceback

Please refer to the [4.2 tuning guide notes](https://github.com/betaflight/betaflight/wiki/4.2-Tuning-Notes#settings-to-minimise-bounceback).


## Presets  **not merged yet**

Betaflight's defaults originally were made to suit 5" freestyle machines intended for fun flying in the park.  These days there are huge performance differences even within 5" builds, with race, freestyle, and cinematic applications.  And of course we have whoops, heavy camera builds, 7-10" and X-class builds, all with different performance envelopes.

4.3 provides a number of presets, in CLI snippet form, that can be easily applied via the new Presets tab in Configurator.

It's easy and intuitive to search for, and apply, a preset that should suit your machine.

A preset should ideally be loaded after flashing, and used as a basis for further tuning, if needed.

Presets are 'approved' after evaluation via the GitHub 'pull request' method, and are not included in Configurator unless we are confident that they work really well.  

Comments or feedback on any given preset should be provided via [github](https://github.com/betaflight/firmware-presets/pulls). 


## New tuning sliders

Betaflight's sliders have been completely revised, with finer control, and a slightly different set of options.

The most obvious change is that P and D are now independently configurable.  A user can tune by increasing both together, to maintain P:D ratio, or adjust D first, or P first, whatever method they prefer.  The overall balance and strength of P and D is visually obvious from their respective slider positions.  Typically a user would focus first on tuning P and D.

Note that I increases or decreases with the P slider, since generally quads that can run high P can run high I, and also to avoid situations where people cut P a bit and then get I wobbles.  Once you have P and D tuned, you can then go to expert mode, if needed, to fine-adjust I with its dedicated slider.

We also have sliders to fine-tune roll settings relative to pitch.

The feedforward or 'stick responsiveness' slider hasn't changed.

We're confident that these sliders will work effectively for both beginners and experienced tuners.  

Being able to adjust them via the OSD or Lua, even if only numerically, will help tune the quad more easily on the field.

## More accurate loop times  **not merged yet**

Steve C Evans has made massive changes, which reduce PID loop jitter and improve overall efficiency of the scheduler.  No special configuration is required; it just works. You'll get improved filter accuracy, cooler motors and longer flights.

Boards with a hardware external interrupt line from gyro to FC will be able to schedule new gyro data more immediately and precisely.

It's best to run F405 and F411 boards at 4k, not 8k, if RPM filtering is enabled.  F411's should be overclocked to 120Mhz.

DShot600 now works reliably on most boards.  Don't use DSHot300 unless there are RPM errors in the motors tab, or if you find that only DShot300 works reliably (some setups still need DShot300 ).

Blackbox logging over SPI to flash and SD is now much more efficient, so that higher logging rates will work with fewer gaps.  Even so, logging is a significant time consumer, so turn it off if you don't need it, and only log as fast as is needed, eg 1kHz for normal purposes, 2Khz for filter tuning.

Remember these notes from 4.2 about retaining the hardware lowpass 2 filter in 4k loops!  If gyro lowpass 2 is disabled, a simple 2-point averaging filter is automatically enabled in its place when 4k or lower PID loop rates are selected. This is not as good as a lowpass 2 filter at 1000hz, and nowhere near as good as 500hz.  **Gyro lowpass 2 should not be disabled for 4k PID loops, and must be retained with 2k PID loops**. 

8k PID loops have no aliasing issues, so gyro lowpass 2 can be disabled if it's not needed, without aliasing concerns.

## Multi dynamic notch

The new SDFT based notch can track multiple independent noise peaks, and assign a notch filter to each peak.  The user can specify however many notches they want to use.  Usually two or three are needed, depending on the build.  

The SDFT tracking is much better than before.  

The dynamic notch has been optimised to control resonance problems, whereas the RPM filter is still best for RPM related noise.

Q values around 300-450 work well for freestyle applications, and keeping the minimum value as high as practical (eg 200hz) will minimise filter delay.  

To tune it really properly, make a log with the dynamic nothch off, do a spectrum analysis and see if there is resonance that needs to be controlled, and what the resonant frequencies are.  Set the dynamic notch range to include the resonant peaks, fly again, and check that the incoming resonance lines have gone from your gyro traces.  Then repeat with higher Q values to find the highest Q value that adequately controls the resonances.

The dynamic notch code will work reasonably effectively, with three or four notches and Q values around 120, to suppress motor noise on quads that cannot run RPM filtering.

## PT3 based RC smoothing

The RC smoothing system has been simplified and improved.  Cinematic or HD pilots can now get amazingly smooth results that were impossible before.

The old linear interpolation method has been removed, so that only a filter-based method is available.  

We very strongly recommend keeping rc smoothing 'on' at all times - ie with `set rc_smoothing = ON`.  If you turn it off, your motors will get very notchy drive signals, run hotter and noisier, and lower link speeds will shake the quad at link frequency.  

The auto smoothing algorithm detects your RC link speed on arming as before, and adapts to changes in the link speed during flight in the same way it always has done (though it takes a while to do so).

The default auto smoothing value is now 30, which gives a reasonably well-smoothed setpoint line and very little delay from the un-smoothed signal.

For HD freestyle, a value of 60 will provide greater smoothness and not a whole lot of extra delay.

For cinematic video, where absolute smoothness for all stick inputs is needed, the new PT3 filtering at auto values of 90-120 will give that silky effortless smoothness you are after, with obvious delay for small inputs.  

The auto smoothing function adjusts the filters to give the least delay for the given link speed.  Hence for cinematic flying with a fast radio link, and for crossfire in a non-locked mode, it may be best to manually over-ride the auto smoothing.  This can be done by by setting a non-zero cutoff value in the CLI.  For cinematic purposes, 10-15hz works well, regardless of link speeds, and for non-locked crossfire, which can swap between 50Hz and 150Hz, randomly, a value of 30hz will give reasonably consistent stick feel.

In most cases, stick with the default auto smoothing, and once you've decided on your radio link speed, or after changing radios, just change the auto smoothing value to suit what you want to do with the quad.  

We generally don't advise going below 30 for auto smoothness, though at high link speeds, eg 250 or 500hz, a value of 20 may be good for racing, by keeping delay to the absolute minimum.  There will be some transfer of the RC link frequencies into your motors, but not much.  If you can hear a difference, or your motors run warmer, go back to 30.

Slower RC Links may benefit from a little more auto rc smoothing than faster links, eg 45 or 60 for 50hz, especially if absolute smoothness is needed.

The auto value for throttle is independently adjustable, depending on whether you want to smooth throttle or not.  I think its best left at 30, unless you are a high link speed racer and want to try 20; if you want to avoid throttle jumps on a cinematic build, go higher, but be wary of throttle lag when you need to pull up from a dive :-)

The auto smoothing is applied equally to setpoint and feedforward.  The log header will show the actual frequencies being used with your link.  In the CLI you can manually configure the amount of smoothing on feedforward relative to setpoint.  We are not sure that this is useful, in any practical sense.  It makes more sense to control stepping in feedforward by using feedforward_smoothing; heavy RC smoothing on feedforward will delay it quite a lot.


## RPM crossfading  **not merged yet**

This is a brilliant improvement over normal RPM filtering, which gives much cleaner motor signals at low to mid-throttle, and improves propwash considerably.  Basically we now can have the RPM filtering benefits when we need them, with none of the drawbacks when they are not needed.

We discovered that notch filters operate by generating an 'anti-noise' signal at their specified cutoff frequency.  They don't generate 'delay' in the same way that a lowpass filter does.  They make a signal which, when mixed with the original, 'cancels out' the noise in the original signal.

This means that we can attenuate a notch filter in a linear fashion, by 'cross-fading', or 'mixing', it's 'anti-noise' signal in, or out - like an audio mixer

This is extremely useful for the RPM filtering, because, previously, whenever a motor went below the minimum RPM frequency, its three RPM notches would all remain active, but be held at their minimum frequency.  While there was no noise to remove, they generated 'delay' and reacted to nearby frequencies, and causing a form of intermodulation distortion, and worsening propwash.

Now we cross-fade the rpm filters in and out, linearly, over a range above the minimum rpm value.

Below the minimum rpm value, the rpm filters are completely 'off', and cause no delay or interference of any kind, resulting in cleaner and better gyro traces than before.

Within the cross-fade region, the RPM filters gradually come back on.  

In most builds, significant RPM related noise doesn't start to happen until about 100hz (6000 rpm).  So we can start the RPM filtering at say 80hz and cross-fade it over 50hz, so that by 130hz, or 10,000 rpm, you have full RPM filtering active again.

We have found a cross-fade range of 50hz to be optimal in most cases.

The default minimum RPM value, where RPM first starts to 'switch on', of 80hz, also works well for most quads.  Machines with very clean props and very little intrinsic RPM noise can have this value shifted higher.

Obviously for large quads with low RPM we would choose proportionally lower values.


## Feedforward jitter reduction  **not merged yet**

This is a really exciting change that gives real smoothness when you want it - but with a ton of snap when you want it too.  It basically replaces the old Dterm/feedforward 'transition', completely.

Feedforward, especially with boost, is known as the 'stick responsiveness' parameter, and for good reason.  

It provides an immediate reaction to stick inputs, while avoiding overshoot.  A good amount of feedforward (say 120) will make the quad super responsive.  It helps give those 'snap' freestyle inputs that many people really like, and gives race pilots the ability to have near-zero setpoint-to-gyro lag, without overshoot.

However, it accentuates the most tiny of twitches, whether from nervousness, slightly sticky gimbals, RC link irregularities, or indeed almost any cause, that can result in an erratic HD image from small scale shaking of the quad.

The 'old' way to minimise this was to use feedforward transition, which checked your stick position, and linearly attenuated feedforward down to zero when close to the center position.  This solved the problem of 'too much feedforward' - but only at centre sticks.

However, transition has a number of limitations.  It only works when the sticks are centred - so if you are in a smooth turn, all that jitter can come back.  When you move the sticks across the centre, in a smooth move, transition will cut the feedforward out abruptly at centre, causing a wobble, worst with narrow transition ranges.  If you do make the transition range wide, you lose all feedforward in the middle, so you can't snap out, and then you'll overshoot on the extremes of stick position where the feedforward is least useful.

Jitter reduction is a way to get the smoothness we want by attenuating feedforward strongly when the sticks are moving slowly, but not delaying it at all for bigger inputs.  

Think of it as a kind of 'dynamic transition'.

The default value of 7 works best for most quads with normal radio links, and is suitable for racing, ensuring that tight turns, and high-speed straights, are both smooth and responsive.

Experienced race pilots with higher speed links will find that the straight-line sensitivity is a bit less than normal, because for very small inputs, their feedforward 'push' is attenuated.  They may prefer a value of 5.  After a few flights we find that the quad 'stays on the intended line' quite a bit better than before, especially during tighter turns, which feel more 'on rails'.

A value of 12-15 pretty much removes all feedforward from slow smooth inputs, at normal RC link speeds, and is what we suggest for freestyle/cinematic.  The quad will be smooth whether flying straight on on a smooth arc or in a sustained tight turn.  However, if you flick the sticks, the response will be immediate.

How it does this magic is simple, in principle.  We look at how much the RC command values change from packet to packet, and average the two most recent values.  We then fade out the feedforward values when the RC change is small, but let it through unchanged when the RC command changes are bigger.  

The `feedforward_jitter_reduction` number is the threshold for the RC Command change, in tenths of a percent, below which feed-forward is attenuated.  A value of 10 means RC command changes of less than 1% per RC step will result in feedforward attenuation.  Attenuation below the threshold follows a kind of exponential curve, so that with a value of 10, there will be barely 10-20% of the normal feedforward for rcCommand steps of 0.1% to 0.2% of the full RC range per packet.

Both link frequency and link bit depth have an impact on a suitable jitter reduction value.  At low link frequencies, eg 50hz, most RC steps are large, and there really isn't much of a jitter issue to worry about.  So the defaults and the suggested freestyle values actually do OK for 50hz to 150hz.  

Higher link speeds, eg 250hz, run into a problem where there is only a limited number of steps available, and not much time for a change to be detected.  Crossfire and FrSky protocals only provide 800 steps across the full RC range, or only 400 steps from centre to max position.  If the pilot moves the stick slowly over one second to max, some RC steps will be one, and others two, packets high.  Small steps like that vary by 100% from step to step, leading to a lot of jitter in feedforward, which thinks that the sticks are shaking massively.  The person's intrinsic jitter and the gimbal itself makes jitter noise of at least this magnitude, and feedforward would ordinarily amplify it - just like D amplifies gyro noise.  

This is where the jitter reduction code helps remove that residual noise in higher speed links; its kind of like a dynamic, zero delay filter, applied to feedforward when the signal to noise ratio would be bad.  It applies first order filtering to the simple setpoint derivative and second order filtering to the boost element.  

Hence the jitter reduction system markedly reduces gimbal jitter on all systems, but is most effective, and important, in higher link rate systems with only 800 steps.  For that reason we suggest keeping it at the default value on all RC links, increasing it for freeestyle and cinematic, and maybe dropping back to 5 but only on clean RC links for race purposes.

The newer RC link protocols with 2000 steps will provide better resolution, however gimbal noise will remain a problem, and hence the jitter reduction code is likely to remain needed for the forseeable future.


## Other feedforward improvements

A number of small, but significant, feedforward changes result in a smoother signal with less delay.

All parameters in the CLI that relate to feedforward now start with `feedforward`, not `ff_`.  Go `get feed` to list them all.

The old `ff_smooth_factor` code has been updated, and it is now named `feedforward_smooth_factor`.  It provides second order step height smoothing for boost, as well as the usual first order smoothing to the simple derivative.  This gives more effective smoothing of the boost signal with less delay to the simple derivative.

A suitable starting value of 25 is adequate for most builds.

`feedforward_averaging` is now set to 'off' by default, since most builds won't require it.  It should be set to `3_POINT` to provide three point moving averaging for old Crossfire 150l links.  Noisy 500hz RC links may benefit from `2_POINT` averaging, but the new jitter reduction code means that 250hz and lower are usually OK without averaging.

`feedforward_max_rate_limit` replaces `ff_max_rate_limit` and is the value that pulls back on feedforward as the sticks approach their maximum rate, minimising overshoot when hitting max stick position.  A bug that limited its usefulness has been fixed.  A value of 90 works best for most quads.  

Duplicate packet interpolation has been improved a lot, so that feedforward now can cope very well with duplicates.  Since duplicates occur frequently, at slow stick movement speeds, since we get 'step.nothing, nothing, step, nothing' tyoe data patterns, we need to not interpolate these duplicates or we magnify the steps inappropriately.  The jitter reduction value is applied now to the interpolation process, so that we get full interpolation while the sticks are moving fast (to fill in a gap that otherwise would jolt the quad), but we interpolate very little when the sticks are moving very slowly.

All up these changes give us a much smoother but super responsive feedforward system.

## AntiGravity improvements

Antigravity now increases P during hard throttle chops, since the abrupt change in pitch angle needs more than I to control it.  Additionally, the timing of the I boost has been changed to better match the timing of the wobble.

The default is now only 3.0, reflecting the greater efficiency of the new code.

Note that it is unwise to run very high AntiGravity values in 4.3, because you run the risk of significant P and I wobble during throttle chops.  

Stick to values close to defaults.  

If you do want to increase AntiGravity, test it methodically.  High values, eg 5 or more, may not achieve much more than normal values; use the lowest value consistent with reasonable control.  

## Dynamic gyro filter expo curve

`dyn_lpf_gyro_curve_expo` allows the dynamic lowpass filter cutoff value to rise more quickly with throttle increases than it used to.  It works much the same as the D lowpass expo.

This reduces delay at higher throttle positions.  If you get significantly more high frequency noise at higher throttle, reduce the amount of expo, or reduce the upper value of the dynamic lowpass cutoff.

For graphs see [PR9486](https://github.com/betaflight/betaflight/pull/9486).

## Improved dynamic idle

The new dynamic idle code now provides a full PID controller.  In place of the `idle_adjustment_speed` and `idle_p` tuning settings, we now have
```
set dyn_idle_p_gain = 50
set dyn_idle_i_gain = 50
set dyn_idle_d_gain = 50
```
This provides more precise RPM control.  The overall concept of dynamic idle is unchanged - [see the notes, which are out of date a bit, here] (https://github.com/betaflight/betaflight/wiki/Tuning-Dynamic-Idle).

Typically higher power quads will need lower PID values, and those with lower authority may benefit from higher PID values. 

A simple test is to set the dynamic idle RPM value well above the normal idle, eg set it to 4000rpm (40), which should be well above normal idle RPM on most quads, and see how stable the motors sound at idle.  If they aren't changing speed or oscillating, the PIDs are OK.  If they are, try less overall PIDs.  If they seem to be wandering around, try more.  Generally the defaults are OK.

Quite a lot of logs show that ESCs have difficulty quickly generating thrust from slow RPM.  Dynamic idle, when set to a fairly high minimum RPM, eg 40, can prevent RPM falling low in reverse airflow states.  This will improve responses when starting and stopping a flip at zero throttle.  

The new code is so good that I can fly my quads (with old BLHeli-S ESCs) on 1% DShot idle and only 1200 rpm as a minimum dybamic idle RPM.  The prop blades are visible turning slowly during LOS flips and rolls, but they don't desync.  For more general freestyle applications, a minimum dynamic idle RPM of 4000, and for racing of 3000, with a DShot idle of 4% usually works really well.


## Linear and Dynamic mixer options

When airmode is active, the default betaflight mixer prioritises PID authority over throttle.  Anytime a motor might need to be driven 'below zero' in order to maintain authority, throttle is increased by airmode so that the requested motor differential can be achieved.  

This airmode-driven throttle increase is the only reason why we can flip and roll 'normally' at zero throttle.

However, there are downsides.  Airmode leads to strong reactions on impacts; the quad will get more throttle and climb.  There is a fairly abrupt change in authority once the limits that Airmode can provide are reached.

These alternate mixer models change the relative emphasis between throttle authority and PID control.

They may have some use in smooth cinematic flying styles, providing a kind of partial airmode effect with less bounce on landing at the expense of limited low throttle PID performance in quicker moves.  If interested, just fly and see if you like them or not.


##Feedforward in Level and Horizon Modes **not merged yet**

In 4.3, feedforward now is applied to both Level and Horizon modes.  

In Level Mode, this results in a quicker response when moving the sticks to quickly change the angle of the quad.

In Horizon Mode, while flying aggressively, the behaviour is now nearly exactly the same as acro, with all the benefits that feedforward brings, in terms of immediate stick response and reduced overshoot.  It feels great!  

In both cases, responsiveness is quicker for the level component.  If you're a beginner and you find it too twitchy, reduce the feedforward value in the PIDs.


## Actual Rates as the new Betaflight default

Starting from 4.3, Actual Rates will be the new Betaflight default.  See PR #10724 for graphs and more information.

`ACTUAL` rates lets you set both the target centre sensitivity and the maximum roll rate in degrees/second.  

The two values are independent of each other.  

Expo shifts the transition point between the two rates to be closer to centre (at zero) or further out (at max).

This online calculator allows visualisation of Betaflight rates vs Actual Rates.  

The new defaults are NOT exactly the same as the old Betaflight rates.  Although the max rate is the same (670 deg/s), the new defaults are softer in the centre (centre sensitivity of 70, compared to about 200 in Betaflight's old defaults), and more responsive further out.  See the [image in the pull request](https://github.com/betaflight/betaflight/pull/10724).

It is hoped that these will be easier to learn on and better suited to freestyle.  

Some experienced race pilots use 200deg/s centre sensitivity and 620 max, with no expo.  With the jitter reduction code, 200deg/s gives very quick turn-in but remains smooth and controllable in tight turns.  Others prefer lower values.

Betaflight rates users can use this [rates calculator](https://www.desmos.com/calculator/r5pkxlxhtb) to find an Actual rates equivalent to what they currently fly.  For instance, centre of 200, max 670, and expo of 0.58 results in the original default Betaflight rates curve.

If a user pastes in their Betaflight rates numbers from say a 'diff all', the `rates_type` information will not be included.  The result will be that Actual Rates will be active, but with Betaflight CLI numbers.  The quad will be un-flyable!  That's why its a bad idea to copy and paste diff all's.  Be sure to recreate your Rates manually, or, if you do a copy and paste, be sure to include the `rates_type` line from the CLI dump command when pasting your rates in.  


## PT2 and PT3 lowpass filtering options

In the past, the second-order Biquad filter was available as an option for gyro and D smoothing, when first-order filtering wasn't enough.  However, we have learned that it oscillates with step inputs and overshoots near cutoff, and won't be using it anymore for lowpass filtering anywhere in the code.

If you needed second order gyro filtering, use the PT2 option, which works much the same.

The PT3 option is a very strong filter, and doesn't have much of an application for gyro or D lowpass filtering, except perhaps as the sole dynamic lowpass on D.

Compared to a PT1, filter delay increases by about 60% with a PT2 and doubles with a PT3.  For full details [check the PR](https://github.com/betaflight/betaflight/pull/10727).


## CrossfireV3 and Ghost RC link improvements **not merged yet**

4.3 has a fully float based internal RC data path, resulting in no aliasing or loss of resolution regardless of RC packet contents.  We also support Crossfire V3 and 11bit Ghost protocols.

We also better support very low frequency link rates - down to 16hz - by constraining the RC smoothing, and avoiding false packet timeout errors which would otherwise trash feedforward  And we support up to 1000hz links by allowing deviations to 950ns without declaring an error.

Blackbox logs now show un-smoothed rcCommand, and the RC and feedforward debugs show un-smoothed Roll setpoint and other useful data for RC link quality and resolution checking.  

## Configurator improvements

So many...

- presets
- new sliders
- parameters in the right places
- motor mapping and rotation widgets in the Motors tab
- warning about manually flashing the wrong target
- fixes and updates

<HR>

***
Credits:
- Firmware PR management - Mikeller
- Configurator and Blackbox management - McGiverGim, Haslinghuis, Blckmn, Limon, Asizon, Mikeller
- Presets - Limon, Mikeller
- Sliders - Haslinghuis, UAVTech/spatzengr, IllusionFPV, Asizon, ctzsnooze
- Looptime, scheduler, DMA, Gyro EXTI, improved logging and OSD efficiency - Steve C Evans, many massive PR's :-)
- Multi dynamic SDFT notch - Karatebrot #10554
- RC smoothing - ctzsnooze #10629, #10650
- RPM crossfading - Karatebrot #10757
- Feedforward jitter reduction - ctzsnooze #10670
- Feedforward smoothing - ctzsnooze - #10164
- Antigravity - ctzsnooze #10163
- Expo on Gyro LPF - IllusionFPV #10239
- Linear and Dynamic mixer options - TylerCorleone, BorisB #10370 
- Dynamic idle improvements - ctzsnooze #10294
- Configurator brilliance - Haslinghuis, McGiverGim, Asizon
- LUA Script - klutvott123
- Feedforward in level and horizon - ctzsnooze #10778
- PT2 and PT2 lowpass filter options - ctzsnooze #10727
- RC Link improvements - TBS #10675, Stepan Dalecky #10801
- default to Actual rates - ctzsnooze #10724

Bugfixes - lots of people!

Keeping everyone and everything on track - blckmn, mikeller

Encouragement and testing - Brian White, James, SugarK, Cory Ibanez, Tehllama42, SupaflyFPV, UAVTech, QuadMcFly, Limon, bizmar, many others : thank you!