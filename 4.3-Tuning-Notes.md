# DRAFT - some things mentioned here have not been merged yet!

## [Betaflight 4.3](https://github.com/betaflight/betaflight/releases) brings:

Overall, a smoother, quieter, yet more precise flight experience than ever before, thanks to:

- [Presets](4.3-Tuning-Notes#Presets) - A fantastic, completely new preset system!  Whether a whoop, a twig, a 5" racer, a freestyle setup, or an X-class, we now provide a simple way apply a great tune for your quad, out of the box.  This will also be expanded to other non-tuning presets soon.
- [New PID based tuning sliders](4.3-Tuning-Notes#New-tuning-sliders) - Whether you need to tweak the tune or build it from scratch, we now have simpler, more comprehensive, firmware based tuning sliders in the Configurator.  These are *active by default*. Slider positions are stored with the quad, and can be modified via the OSD.  New expert sliders allow fine-tuning of Pitch:Roll balance, DMax:Dmin, and I relative to P.  
- Changed default PID and filter values - less gyro filtering, higher P and D, to provide better default flight stability.
- [More accurate loop times](4.3-Tuning-Notes#More-accurate-loop-times) - Massive scheduler and DMA code improvements, including EXTI triggered SPI gyro reads (on supported boards), super stable looptimes, smoother filter performance, faster logging and improved CPU efficiency.
- [Multi dynamic notch](4.3-Tuning-Notes#Multi-dynamic-notch) - Completely rewritten, much improved, SDFT based multi-dynamic notches.  More than one resonant peak can be tracked at the same time, more accurately and more quickly than before, keeping motors smoother and cooler.  
- [PT3 based RC smoothing](4.3-Tuning-Notes#PT3-based-RC-smoothing) - RC smoothing has been completely revised, and is now entirely filter based, using optimised PT3 (third order) smoothing.  The auto smoothing value provides anything from near-zero delay to exceptional cinematic smoothness.
- [RPM crossfading](4.3-Tuning-Notes#RPM-crossfading) - we now can smoothly disable overlapping RPM filtering notches entirely at low RPM.  This greatly reduces filter delay at low throttle.  You’ll hear an immediate difference in the sound of the motors, and get less propwash.
- [Feedforward jitter reduction](4.3-Tuning-Notes#Feedforward-jitter-reduction) - 4.3 introduces feedforward jitter reduction, which delivers a kind of ‘dynamic transition’ effect, allowing users to ditch FF transition.  You'll get silky smooth responses to slow stick inputs, and immediate, snappy feedforward responses to quick inputs.  Jitter reduction also attenuates RC link noise during slow movements, especially for the newer higher rate Rx links.  This replaces the old spike removal code and makes transition obsolete.
- [Other feedforward improvements](4.3-Tuning-Notes#Other-feedforward-improvements) - We now have second order smoothing on boost, soft interpolation during slow stick moves, more accurate duplicate packet interpolation, so that most radios won't need averaging, which is now off by default.  
- [AntiGravity improvements](4.3-Tuning-Notes#AntiGravity-improvements) - P boost has been added, along with I boost timing optimisation to peak when it is most needed.  This provides greater stability during rapid throttle changes.  The default value of 3 should not be increased without careful testing.
- [Dynamic gyro filter expo curve](4.3-Tuning-Notes#Dynamic-gyro-filtering-expo-curve) - Adjusting filter expo curves improves propwash by raising dynamic gyro filter cutoff values more quickly as you throttle up.
- [Improved dynamic idle](4.3-Improved-dynamic-idle) - The dynamic idle code has been heavily revised, and can now keep RPM at a more stable value, more quickly and more precisely than before, thanks to a modified single sided PID controller.  It can now be configured to hold RPM above the normal idle value, improving motor spin-up-from-low-rpm behaviour, while allowing motor drive to go to zero for enhanced braking when appropriate.
- [Linear and Dynamic mixer options](4.3-Tuning-Notes#Linear-and-Dynamic-mixer-options) - These are alternatives to the stock Betaflight mixer code.  The dynamic option may result in less aggressive bump and landing responses for level mode or cinematic flights.
- [Feedforward in Level and Horizon Modes](4.3-Tuning-Notes#Feedforward-in-Level-and-Horizon-Modes) - Feedforward is now active in horizon and level modes, leading to quicker level mode angle changes, and making Horizon mode as responsive as Acro for flips and other fast moves.  The amount of feedforward can be adjusted and saved in the profile, like for the other PID parameters.
- [Actual Rates as the new Betaflight default](4.3-Tuning-Notes#Actual-Rates-as-the-new-Betaflight-default) - Actual rates provide a simpler and more intuitive way to set your Rates, and are now the default.  Default rates are a little bit different from the previous defaults, being a bit less aggressive in the centre, but more progressive around mid-stick.  Full-stick max roll rate is the same as before.  Betaflight rates are optional.  *Take care when updating! If you copy and paste your old rates values, be sure to copy and paste the rates type also!*  Use this calculator to [convert your old rates to Actual rates](https://www.desmos.com/calculator/r5pkxlxhtb).
- [PT2 and PT3 lowpass filtering options](4.3-Tuning-Notes#PT2-and-PT3-lowpass-filtering-options) - The old biquad lowpass filter option is no longer available, due to overshoot and resonance issues.  Previous biquad lowpass users should change to PT2 if they need second order filtering.
- [CrossfireV3 and Ghost RC link improvements](4.3-Tuning-Notes#CrossfireV3-and-Ghost-RC-link-improvements) - As well as support for the latest Crossfire, ELRS and Ghost protocols, the internal betaflight RC code now supports 12bit or higher RC data in a float data path, handles very low RC Links (down to 16hz) better than before, fully supports high speed links to 1000hz, and better attenuates feedforward glitches when the RC link returns after dropouts.
- [FrSky OSD fix](4.3-Tuning-Notes#Frsky-OSD-fix) - Asizon fixed it!
- [Lua script updates](4.3-Tuning-Notes#Lua-script-updates) - RSSI in your OSD via LUA, slider control from the radio, amongst lots of other changes.
- Changed CLI command names


>**NOTE 1**:The [latest nightly 10.8 Betaflight Configurator](https://github.com/betaflight/betaflight-configurator-nightlies) is MANDATORY.  Earlier 10.8 and 10.7 configurator versions will not work properly!

>**NOTE 2**: DO NOT paste a whole diff or dump from any prior build into the 4.3 CLI!  Invest the time in setting it up manually.  If you can use a Preset, do so.  If possible, use the sliders to approximate your old PIDs and filter settings.

>**NOTE 3**: Check all your settings carefully before attempting to arm for the first time.  In particular, check your Rates!  READ THIS NOTE!  Before arming, double-check motor configuration and rotation in the Configurator motors tab.  For the first flights, arm in a safe place, and fly gently.

>**NOTE 4**: Sliders are active by default!  The slider positions will over-ride any pasted-in PID or filter settings that they control.  Before pasting in PID values, disable sliders in Configurator.  [See](4.3-Tuning-Notes#New-tuning-sliders).

>**NOTE 5**: We strongly recommend flying the default antigravity value of 3.0 and only trying higher values if testing shows that there is a definite improvement [see](4.3-Tuning-Notes#AntiGravity-improvements).  

>**NOTE 6**: We strongly recommend using RPM based filtering.  Read about [enabling and configuring rpm filtering here.](https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter)


**4.3 should fly really well on defaults, with no modifications, with most quads - but if a preset exists that resembles your build, use it!**


If you're new to Betaflight, please read the previous tuning notes ([4.2](https://github.com/betaflight/betaflight/wiki/4.2-Tuning-Notes), [4.1](https://github.com/betaflight/betaflight/wiki/4.1-Tuning-Notes) for any topic that isn't covered here.


<HR>

## Quick settings 

These snippets are suggestions to suit a certain type of flying.  Generally, using a preset will work better.  I can't say that they will be perfect on your quad, and they do not include PID tuning or filter values, but illustrate how some of the new values can be adjusted to suit particular requirements.

**Race** 
```
set iterm_relax_cutoff = 25

set rc_smoothing = ON
set rc_smoothing_auto_factor = 30
set rc_smoothing_auto_factor_throttle = 30
set rc_smoothing_setpoint_cutoff = 0
set rc_smoothing_feedforward_cutoff = 0
set rc_smoothing_throttle_cutoff = 0

set feedforward_transition = 0
set feedforward_averaging = OFF
set feedforward_smooth_factor = 25
set feedforward_jitter_reduction = 7
set feedforward_max_rate_limit = 90
set feedforward_boost = 15

set yaw_lowpass_hz = 100

set throttle_boost = 5
set throttle_boost_cutoff = 25

set dyn_lpf_dterm_curve_expo = 7

set gyro_rpm_notch_q = 450
set gyro_rpm_notch_min = 80
set gyro_rpm_notch_fade_range_hz = 60
set gyro_rpm_notch_harmonics = 2

set dyn_notch_count = 2
set dyn_notch_q = 450
set dyn_notch_min_hz = 160
set dyn_notch_max_hz = 600

set rates_type = ACTUAL
set roll_rc_rate = 20
set pitch_rc_rate = 20
set yaw_rc_rate = 20
set roll_srate = 65
set pitch_srate = 65
set yaw_srate = 65
set roll_expo = 0
set pitch_expo = 0
set yaw_expo = 0

set vbat_sag_compensation = 100
set throttle_limit_type = SCALE
set throttle_limit_percent = 95

set gyro_lowpass_type = PT1
set gyro_lowpass_hz = 0
set dyn_lpf_gyro_min_hz = 0
set dyn_lpf_gyro_max_hz = 1000
set dyn_lpf_gyro_curve_expo = 5

set gyro_lowpass2_type = PT1
set gyro_lowpass2_hz = 500

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 150
set dyn_lpf_dterm_min_hz = 75
set dyn_lpf_dterm_max_hz = 150
set dyn_lpf_dterm_curve_expo = 6

set dterm_lowpass2_type = PT1
set dterm_lowpass2_hz = 150
````

**Fast Freestyle** (paste the race settings into CLI, then paste these modifications, and save)
```
set iterm_relax_cutoff = 20
set rc_smoothing_auto_factor = 45
set feedforward_jitter_reduction = 10
set feedforward_smooth_factor = 30
set dyn_lpf_dterm_curve_expo = 7

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 150
set dyn_lpf_dterm_min_hz = 75
set dyn_lpf_dterm_max_hz = 150

set roll_rc_rate = 10
set pitch_rc_rate = 10
set yaw_rc_rate = 10
```

**HD** (smoothed FF for HD cameras, strong low turn rate smoothness, low iterm relax to minimise bounce back - (paste the race settings into CLI, then paste these modifications, and save)
```
set iterm_relax_cutoff = 10
set rc_smoothing_auto_factor = 60
set feedforward_jitter_reduction = 12
set feedforward_smooth_factor = 35
set dyn_lpf_dterm_curve_expo = 7

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 150
set dyn_lpf_dterm_min_hz = 75
set dyn_lpf_dterm_max_hz = 150

set roll_rc_rate = 5
set pitch_rc_rate = 5
set yaw_rc_rate = 5
```

**Cinematic** (For smooth cinematic flying, will feel very 'dull' otherwise)
```
set iterm_relax_cutoff = 5
set rc_smoothing_auto_factor = 120
set feedforward_jitter_reduction = 12
set feedforward_smooth_factor = 45
set dyn_lpf_dterm_curve_expo = 7

set throttle_boost = 2
set throttle_boost_cutoff = 10

set dterm_lowpass_type = PT1
set dterm_lowpass_hz = 150
set dyn_lpf_dterm_min_hz = 75
set dyn_lpf_dterm_max_hz = 150

set roll_rc_rate = 1
set pitch_rc_rate = 1
set yaw_rc_rate = 1

set iterm_windup = 75 # for larger or ducted quads; 50 for really big ones
````

### Bounceback

Please refer to the [4.2 tuning guide](https://github.com/betaflight/betaflight/wiki/4.2-Tuning-Notes#settings-to-minimise-bounceback).  Most bounce-back is due to too much I on a low authority quad, and is usually best fixed by cutting back the iterm_relax cutoff value.

### Random wobbles in HD footage
The following suggestions may help minimise this problem:
- tune for the highest possible D, avoid setting P too high
- set D_min at about 75% of DMax
- get D_max close to P, or up to 20% above P (you may need more D filtering - check the motor temperatures and don't go too high!)
- set TPA to D only (default), starting just below the cruising throttle value
- use about 2/3 the default I on pitch and roll
- make sure the ADC is not ticked in the hardware settings of OpenTx!!
- make sure the frame is super stiff and nothing is able to wobble or flap around
- be sure your capacitor is big
- sometimes the gyro chip isn't great, and some ESCs just don't play nice, if all else fails, try changing these parts from a quad that does fly perfectly.

### Zero throttle instability
- go back to 24kHZ PWM if you've set the ESc to 48kHz
- enable dynamic idle at 4000 RPM or whatever gives a solid spin on arming
- try thrust linear at 25
- try slightly higher overall PIDs


<HR>

## Presets
(*not merged yet*)

This is probably the most useful improvement to Configurator in a long time. 

Betaflight's defaults originally were made to suit 5" freestyle machines for fun flying in the park.  These days there are huge performance differences between 5" race, freestyle and cinematic builds, and even greater differences between whoops, twigs, heavy camera builds, 7-10" and X-class builds.  They all have very different performance envelopes.

The 4.3 Configurator release (10.8) now provides a Preset system, make it easy to find one or more sets of CLI commands that your Rx, VTX or OSD configuration, and then to find a tune that suits your quad, your flying 'style', and so on.  Once you've applied those Presets, hit Save and go fly!

Presets may include 'options', and can be used to reset parts of the machine to defaults.

WARNING:  Always backup your quad's configuration, by saving a CLI 'dump' file, BEFORE 'saving' a Preset!  Once you've saved a Preset, the changes are permanent.  There is no 'easy way' to reverse saved changes! Feel free to check out as many different Presets as you like, but once you save, there is not going back.  

Presets are 'approved' after evaluation via the GitHub 'pull request' method, and are not included in Configurator unless we are confident that they are 'good'.  

To add a new Preset to Betaflight, open a [pull request](https://github.com/betaflight/firmware-presets/pulls).

Comments or feedback on any given preset should be provided via the [originating pull request](https://github.com/betaflight/firmware-presets/pulls). 


## New tuning sliders

We've completely overhauled the PID tuning sliders!  They give us a very quick and simple way to tune the quad, whether at the field or at your computer.

- Slider positions are now stored in the flight controller, and can be updated via the OSD or Lua, at the field. 
- P and D are now set independently with their own specific sliders. No more P:D ratio and P&D gain.
- Basic mode users can adjust three sliders (PI, D and Feedforward), with limited adjustment range.
- Expert mode sliders allow fine-tuning of I, Dmax, and pitch:roll ratio for D and P, and overall master gain.
- When an Expert mode slider is not at its default position, or a Basic slider is outside the basic adjustment range, it is visible, but greyed out, in basic view.  To adjust a 'greyed out' slider, switch to Expert view.
- P:D ratio can, approximately, be retained by moving both PI and D sliders together, keeping similar relative positions
- The master gain slider can be used to increase or decrease overall PID strength, keeping everything in exact proportions

The balance and overall strength of P and D is now visually obvious from their respective slider positions.  

### Simple tuning

The quickest, simplest way to tune with the new sliders, is to move both the P and D sliders together to the right until something 'bad' happens.  This retains P:D ratio, roughly.  Stop, or pull back slightly, when either the motors get hot or you hear bad noises in high-speed turns, or on arming, then back off a bit.  For quick and simple tuning, this is very likely to give you a really good result.

Alternatively, we can quickly get our gains 'in the ballpark' with the Expert-mode 'Master Slider'.  This increases or decreases all PID in strict proportion.  Once we have it about right, individual sliders can fine-tune the result.

### The "D-first" tuning method

The 'D first' tuning method involves stepwise increases in D until something bad happens, then easing back a click or two, and not going higher.  After that, the process is repeated for P, then you're done.  

It is based on two fundamental concepts:
- the more D you can apply, the more P you can use;
- generally, a quad will track best with the highest P and D it can tolerate.  

The following are common indications, while increasing D, that it's time to drop back a bit:
- motors getting hot, 
- we hear grinding or humming sounds on arming
- the quad noisily 'flies to the moon' on arming
- bent props make the motors really hot really quickly

We know that the primary limit on how much D you can run is how clean the build is.  Builds with good bearings, well balanced and well centred motors, stiff frames, stiff props, etc, will accept more D.  Different props or ESC settings can have an influence.

Once you've set D as high as it can reasonably go, bring P up until something bad happens, e.g.:
- a fluttering sound from P oscillation in hard mid to high throttle turns, or 
- under-damped short duration overshoots or resonances in step responses, or
- straight out P oscillation.

Usually most quads end up with P around the D value, or a bit higher.  

### The 'classical' tuning method

This method pushes P upwards to its limit with modest D, then brings D up as much as we can, and finally brings P up again to see if we can now, at higher D, lift P a little more.  

Usually start with D at defaults or slightly below, and then stepwise push P higher one click at a time until we hear that P mediated flutter or oscillation in high-speed turns.  Once you know what 'too much P' does, we ease D up to see if we can attenuate that problem without adding too much motor heat from D related noise or resonance.  Once you know the D limit, you can again see if you can bring P up a little higher, and often you can since you'll have more damping.  The goal is to get both parameters as high as you can without the unwanted issues of flutter, resonance or excessive motor heat.

The new PID Sliders support whatever tuning 'method' the user prefers, including most of those in the familiar YouTube tuning videos.

NOTE:  The D slider brings up both D and Dmax.  Dmax is higher than D by default, and is applied transiently during fast inputs.  There is no need, in 4.3, to push D really high.  Pushing D close to the limit makes the quad quite sensitive to frame softening, bent props, or minor motor damage.   Getting Dmax approximately equal to P, and leaving D itself about 3.4 below P, which is the default arrangement, usually works very well for most quads. 

NOTE: The P slider also brings up I as well, and generally this works well. Doing so helps avoid situations where P was cut without a corresponding I cut.  The amount of I can be fine-tuned later with the expert-mode I slider.

We're confident that these sliders will work effectively for both beginners and experienced tuners, and simplify the transition from 'basic' to 'expert' tuning methods.  Most people, experienced tuners included, should now be able to use the sliders for nearly all their tuning requirements, both on and off the field.


## More accurate loop times

Steve C Evans has made massive changes that almost completely eliminate PID loop jitter and improve the overall efficiency of the scheduler.  No special configuration is required; it just works. You'll get better filter accuracy, cooler motors and longer flights.

Boards with a hardware external interrupt line from gyro to FC can sync the two together. 

In 4.3 it's best to run F405 and F411 boards at 4k, not 8k, if RPM filtering is enabled.  F411's should be overclocked to 120Mhz; they don't run hot like F405's.

DShot600 now works reliably on most boards including F411's.  DSHot300 isn't recommended unless there are RPM errors in the motors tab that only go away if you choose DShot300 (some, but not many, FC's or ESCs still need DShot300 ).

Blackbox logging over SPI is now much more efficient, so that higher logging rates will work with fewer gaps.  Even so, logging is a significant time consumer, so turn it off if you don't need it, and only log as fast as is needed, eg 1kHz for normal purposes, 2Khz for filter tuning.

If running 4k PID loops we strongly suggest always keeping the gyro lowpass 2 filter active, to avoid aliasing when downsampling the gyro. Otherwise if gyro lowpass 2 is disabled at 4k, a simple 2-point averaging filter is enabled in its place. This is not nearly as good an anti-aliasing filter as a PT1 filter at 1000hz, and nowhere near as good as 500hz. For 2kPID loops, a 500hz PT1 lowpass 2 gyro filter is absolutely necessary. 

8k PID loops have no aliasing issues, so gyro lowpass 2 can be disabled without aliasing concerns.


## Multi dynamic notch

The new SDFT based notch can track multiple independent noise peaks, and will assign an independent notch filter to each peak.  The user can specify as many notches as they need.  Usually mo more than two or three are needed, depending on the build, and often only one.

The SDFT tracks noise pecks much more effectively than before.  The code is completely different.  It has been optimised to control resonance problems when used in association with RPM filtering.  The RPM filter is still best for RPM related noise.

Q values around 300-450 work well for freestyle applications.  Keeping the minimum value as high as practical (eg 200hz), and only using the minimum number of notches, will minimise notch related filter 'delay'.

To tune the dynamic notch properly, make a log with the dynamic nothch off, do a spectrum analysis and see if there is resonance that needs to be controlled, and what the resonant frequencies are.  Set the dynamic notch range to include the resonant peaks, fly again, and check that the incoming resonance lines have gone from your gyro traces.  Then repeat with higher Q values to find the highest Q value that adequately control those resonances.

For quads that cannot run RPM filtering, the SDFT code will work reasonably effectively if configured with three or four notches and Q values around 120.

For more detail see [PR #10554](https://github.com/betaflight/betaflight/pull/10554)


## PT3 based RC smoothing

The RC smoothing system has been simplified and improved.  Cinematic or HD pilots can now get amazingly smooth results that were impossible before.

The old linear interpolation method has been removed because the PT3 filter-based method works better (no overshooting, lower latency, better tunability).

We very strongly recommend keeping rc smoothing 'on' at all times - ie with `set rc_smoothing = ON`.  If you turn it off, your motors will get very notchy drive signals, run hotter and noisier, and lower link speeds will shake the quad at link frequency.  

The auto smoothing algorithm hasn't changed,  It detects your RC link speed on arming, sets the RC smoothing cutoffs automatically, and changes their values if the link speed changes in-flight (though it takes a while to do so).

The default auto smoothing value is now 30, which gives a reasonably well-smoothed setpoint line and very little delay when compared to the un-smoothed signal.

For HD freestyle, an auto value of 60 will provide greater smoothness and not a whole lot of extra delay.

For cinematic video, where absolute smoothness is needed, auto values around 90-120 will give that silky effortless smoothness you are after, at the cost of obvious stick delay.  In association with jitter reduction and feedforward smoothing, most cinematic footage will be incredibly smooth.

The auto smoothing function adjusts the filters to give the least delay for the given link speed.  At higher link speeds, the smoothing filters run faster, and give quicker stick responses.  

For cinematic flying with a fast radio link, and for crossfire in a non-locked mode, it may be best to manually over-ride the auto smoothing, to get a consistent amount of smoothness throughout the flight, and across builds with different radio links.  This can be done by by setting fixed, non-auto, values in the CLI.  For cinematic purposes, 10-15hz works well, regardless of link speeds, eg

```
set rc_smoothing_setpoint_cutoff = 10
set rc_smoothing_feedforward_cutoff = 10
````

The same applies to non-locked crossfire, which can swap between 50Hz and 150Hz, randomly.  Here a value of 20-30hz will give reasonably consistent stick feel and reasonable smoothness even in 50hz mode:

```
set rc_smoothing_setpoint_cutoff = 30
set rc_smoothing_feedforward_cutoff = 30
````

We generally don't advise going below 30 for auto smoothness, though at high link speeds, eg 250 or 500hz, a value of 20 may be good for racing, by keeping delay to the absolute minimum.  There will be some transfer of the RC link frequencies into your motors, but not much.  If you can hear a difference, or your motors run warmer, go back to 30.

Slower RC Links may benefit from a little more auto rc smoothing than faster links, eg 45 or 60 for 50hz, with it's big, wide steps, or higher to 90-120 if absolute smoothness is needed.

In most cases, stick with the default auto smoothing, and once you've decided on your radio link speed, or after changing radios, adjust the auto smoothing value to get the result your after.

The auto value for throttle is independently adjustable, automatically or manually, depending on whether you want to smooth throttle or not.  I think its best left at 30, unless you are a high link speed racer and want to try 20; if you want to avoid throttle jumps on a cinematic build, go higher, but be wary of throttle lag when you need to pull up from a dive :-)

The auto smoothing is applied equally to setpoint and feedforward.  The log header will show the actual frequencies being used with your link.  In the CLI you can manually configure the amount of smoothing on feedforward relative to setpoint.  Testing to date has not shown this option to be clearly useful, in any practical sense.  It makes more sense to control stepping in feedforward by using feedforward_smoothing; heavy RC smoothing on feedforward will delay it quite a lot.

For more detail see [PR #10650](https://github.com/betaflight/betaflight/pull/10650)


## RPM crossfading

This is a brilliant improvement over normal RPM filtering, which gives much cleaner motor signals at low to mid-throttle, and improves propwash considerably.  Basically we now can have the RPM filtering benefits when we need them, with none of the drawbacks when they are not needed.

We discovered that notch filters operate by generating an 'anti-noise' signal at their specified cutoff frequency.  They don't generate 'delay' in the conventional sense.  Not in the same way that a lowpass filter does.  They make a signal which, when mixed with the original, 'cancels out' the noise in the original signal.

This means that we can attenuate a notch filter in a linear fashion, by 'cross-fading', or 'mixing', it's 'anti-noise' signal in, or out, like an audio mixer.

This is extremely useful for RPM filtering.  Previously, when any motor went below the minimum RPM frequency, its three RPM notches would all remain active, but be held at their minimum frequency.  While there was no noise to remove, they generated 'delay' and reacted to nearby frequencies, and causing a form of intermodulation distortion, and worsening propwash.

Now, we can essentially 'turn the RPM filters off' when they aren't needed, and bring them back on smoothly over a 'cross-fade' range above the minimum rpm value.

Once the rpm filters are completely 'off', they cause no delay or interference of any kind, resulting in cleaner and better gyro traces than before.

In most builds, significant RPM related noise doesn't start to happen until about 100hz (6000 rpm).  So we can start the RPM filtering at say 80hz and cross-fade it over 50hz, so that by 130hz, or 10,000 rpm, you have full RPM filtering active again.  eg:

```
set gyro_rpm_notch_min = 80
set gyro_rpm_notch_fade_range_hz = 50
```

We have found a cross-fade range of 50hz to be optimal in most cases.

The default minimum RPM value, where RPM first starts to 'switch on', at 80hz, also works well for most quads.  Machines with very clean props and very little intrinsic RPM noise can have this value shifted higher, eg 

```
set gyro_rpm_notch_min = 100
set gyro_rpm_notch_fade_range_hz = 70
```

Very large quads with low RPM we would choose proportionally lower values.

Tuning?  Enable the dshot_telemetry debug, and do some smooth steady throttle-ups, from zero to 50%, with no other stick inputs, and then cut throttle quickly.  Look at where the motor noise comes into the gyros.  Use the debug trace to see when the motor rpm moves above the minimum rpm point, and check how the motor noise behaved in the cross-fade region.  If the minimum rpm is set too high, you'll get motor noise leaking through below the crossfade region.  It can be easiest to set the minimum with a very low crossfade value, eg 10; there will be a sudden change when the rpm filtering kicks in.  Once the minimum is set to a point below where rpm noise becomes an issue, the crossfade range can be extended upwards until it too allows some bleed-through in the cross-over region.  The goal is the highest values consistent with reasonable attenuation of the motor noise.

For more detail see [PR #10757](https://github.com/betaflight/betaflight/pull/10757)


## Feedforward jitter reduction

This is a really exciting change that gives real smoothness when you want it, while keeping a ton of snap when you want it as well.  

It completely removes any need to use the old Dterm/feedforward 'transition' functionality anymore.

Feedforward, especially with boost, is known as the 'stick responsiveness' parameter, and for good reason.  It provides a strong and immediate reaction to stick inputs.  A good amount of feedforward (say 120-130) will make the quad super responsive, without adding overshoot.  It gives those 'snap' freestyle inputs extra zing, and gives race pilots near-zero setpoint-to-gyro lag.

However, it accentuates even the tiniest of RC inputs, and can make for twitchy flight and jerkiness in HD video.  It doesn't matter if those RC twitches come from nervousness, slightly sticky or noisy gimbals, RC link connection problems, they all get exaggerated by feedforward...  Until now.

The 'old' way to handle these 'jitters' was to use feedforward transition, which linearly attenuated feedforward down to zero when your sticks were close to the center position.  This solved the problem of 'too much feedforward' at centre stick position - but nowhere else.

And transition has a number of limitations.  It only works when the sticks are centred; if you are in a smooth turn, all jitter sources can emerge once again.  When moving the sticks across the centre, in a smooth move, transition will cut the feedforward out abruptly at centre, causing a wobble, worst with narrow transition ranges.  If you do make the transition range wide, all feedforward benefit is lost in the middle, and higher values that can potentially cause overshoot on the extremes of stick position emerge due to feedforward becoming activate very late.

Jitter reduction attenuates feedforward strongly when the sticks are moving slowly, regardless of their absolute position.

Think of it as a kind of 'dynamic transition' function.

The default value of 7 works best for most quads with normal radio links, and is suitable for racing, ensuring that tight turns, and high-speed straights, are both smooth and responsive.

Experienced race pilots with higher speed links will find that the straight-line sensitivity will be a bit less than normal, because for very small inputs, their feedforward 'push' is attenuated.  They may prefer a value of 5.  After a few flights we find that the quad 'stays on the intended line' a fair bit better than before, especially during tighter turns, which feel more 'on rails' than before.

A value of 12-15 pretty much removes all feedforward from slow smooth inputs, and is what we suggest for freestyle/cinematic.  The quad will be equally smooth in straight centred flight and in a sustained tight turns.  However, if you flick the sticks, the response will be immediate.

How it does this magic is simple, in principle.  We look at how much the RC command values change from packet to packet, average the two most recent change amounts, and compare that average to a user-configured threshold.  We then fade out the feedforward values when the recent rate of RC change is below the threshold.  But when the RC command changes are bigger than the threshold, we let feedforward through, unchanged and without any delay, to give immediate snap responses when we move the sticks quickly.

The `feedforward_jitter_reduction` number is the threshold for the RC Command change, in tenths of a percent of stick travel, below which feed-forward is attenuated.  A value of 10 means feedforward will be attenuated progressively for RC command changes of less than 1% per step.  Attenuation below the threshold follows a kind of exponential curve, so that with a value of 10, there will be barely 10-20% of the normal feedforward for rcCommand change steps of 0.1% to 0.2% of the full RC range.

Both link frequency and link bit depth have an impact on a suitable jitter reduction value.  At low link frequencies, eg 50hz, most RC steps are large, and there really isn't much of a jitter issue to worry about.  So the defaults and the suggested freestyle values actually do OK for 50hz to 150hz.  

Higher link speeds, 250Hz and above, run into a problem where there is only a limited number of steps available, and not much time for a change to be detected.  Crossfire and FrSky protocals only provide 800 steps across the full RC range, or only 400 steps from centre to max position.  If the pilot moves the stick slowly over one second to max, some RC steps will be one, and others two, packets high.  Small steps like that vary by 100% from step to step, leading to a lot of jitter in feedforward, which thinks that the sticks are shaking massively.  The person's intrinsic jitter and the gimbal itself makes jitter noise of at least this magnitude, and feedforward would ordinarily amplify it - just like D amplifies gyro noise.  

This is where the jitter reduction code helps remove that residual noise in higher speed links; its kind of like a dynamic, zero delay filter, applied to feedforward when the signal to noise ratio would be bad.  It applies first order filtering to the simple setpoint derivative and second order filtering to the boost element.  

Hence the jitter reduction system markedly reduces gimbal jitter on all systems, but is most effective, and important, in higher link rate systems with only 800 steps.  For that reason we suggest keeping it at the default value on all RC links, increasing it for freeestyle and cinematic, and maybe dropping back to 5 but only on clean RC links for race purposes.

The newer 11 bit RC link protocols with 2000 steps will provide better resolution, however gimbal noise will remain a problem, and hence the jitter reduction code is likely to remain needed for the forseeable future.

For more detail see [PR #10670](https://github.com/betaflight/betaflight/pull/10670)


## Other feedforward improvements

A number of small, but significant, feedforward changes result in a smoother signal with less delay.

All parameters in the CLI that relate to feedforward now start with `feedforward`, not `ff_`.  Go `get feed` to list them all.

The old `ff_smooth_factor` code has been updated, and it is now named `feedforward_smooth_factor`.  It provides second order step height smoothing for boost, as well as the usual first order smoothing to the simple derivative.  This gives more effective smoothing of the boost signal with less delay to the simple derivative.

A suitable starting value of 25 is adequate for most builds.

`feedforward_averaging` is now set to 'off' by default, since most builds won't require it.  It should be set to `3_POINT` to provide three point moving averaging for old Crossfire 150l links.  Noisy 500hz RC links may benefit from `2_POINT` averaging, but the new jitter reduction code means that 250hz and lower are usually OK without averaging.

`feedforward_max_rate_limit` replaces `ff_max_rate_limit` and is the value that pulls back on feedforward as the sticks approach their maximum rate, minimising overshoot when hitting max stick position.  A bug that limited its usefulness has been fixed.  A value of 90 works best for most quads.  

Duplicate packet interpolation has been improved.  Since duplicates occur frequently at slow stick movement speeds, we now use the jitter reduction value to attenuate the interpolation process, so that we interpolate very little when the sticks are moving very slowly.

These changes give us a much smoother but super responsive feedforward system.


## AntiGravity improvements

Antigravity now increases P during hard throttle chops, since the abrupt change in pitch angle needs more than I term response to control it.  Additionally, the timing of the I boost has been changed to better match the timing of the wobble.

The default is now only 3.0, reflecting the greater efficiency of the new code.

Note that it is unwise to run very high AntiGravity values in 4.3, because you run the risk of significant P and I wobble during throttle chops.

Stick to values close to defaults.

If you do want to increase AntiGravity, test it methodically.  High values, eg 5 or more, may not achieve much more than normal values; use the lowest value consistent with reasonable control.

See [#10163](https://github.com/betaflight/betaflight/pull/10163) for more detail.


## Dynamic gyro filter expo curve

`dyn_lpf_gyro_curve_expo` allows the dynamic lowpass filter cutoff value to rise more quickly with throttle increases than it used to.  It works much the same as the D lowpass expo.

This reduces delay at higher throttle positions.  If you get significantly more high frequency noise at higher throttle, reduce the amount of expo, or reduce the upper value of the dynamic lowpass cutoff.

For graphs see [PR9486](https://github.com/betaflight/betaflight/pull/9486).

## Improved dynamic idle

The new dynamic idle code now provides a full PID controller.  In place of the `idle_adjustment_speed` and `idle_p` tuning settings, we now have
```
set dyn_idle_p_gain = 50
set dyn_idle_i_gain = 50
set dyn_idle_d_gain = 50
```
This provides more precise RPM control.  The overall concept of dynamic idle is unchanged - [see the notes, which are out of date a bit, here] (https://github.com/betaflight/betaflight/wiki/Tuning-Dynamic-Idle).

Typically higher power quads will need lower PID values, and those with lower authority may benefit from higher PID values. 

A simple test is to set the dynamic idle RPM value well above the normal idle, eg set it to 4000rpm (40), which should be well above normal idle RPM on most quads, and see how stable the motors sound at idle.  If they aren't changing speed or oscillating, the PIDs are OK.  If they are, try less overall PIDs.  If they seem to be wandering around, try more.  Generally the defaults are OK.

Quite a lot of logs show that ESCs have difficulty quickly generating thrust from slow RPM.  Dynamic idle, when set to a fairly high minimum RPM, eg 40, can prevent RPM falling low in reverse airflow states.  This will improve responses when starting and stopping a flip at zero throttle.  

The new code is so good that I can fly my quads (with old BLHeli-S ESCs) on 1% DShot idle and only 1200 rpm as a minimum dybamic idle RPM.  The prop blades are visible turning slowly during LOS flips and rolls, but they don't desync.  For more general freestyle applications, a minimum dynamic idle RPM of 4000, and for racing of 3000, with a DShot idle of 4% usually works really well.

For more detail see [PR #10294](https://github.com/betaflight/betaflight/pull/10294)


## Linear and Dynamic mixer options

When airmode is active, the default betaflight mixer prioritises PID authority over throttle.  Anytime a motor might need to be driven 'below zero' in order to maintain authority, throttle is increased by airmode so that the requested motor differential can be achieved.  

This airmode-driven throttle increase is the only reason why we can flip and roll 'normally' at zero throttle.

However, there are downsides.  Airmode leads to strong reactions on impacts; the quad will get more throttle and climb.  There is a fairly abrupt change in authority once the limits that Airmode can provide are reached.

These alternate mixer models change the relative emphasis between throttle authority and PID control.

They may have some use in smooth cinematic flying styles, providing a kind of partial airmode effect with less bounce on landing at the expense of limited low throttle PID performance in quicker moves.  If interested, just fly and see if you like them or not.

For more detail see [PR #10370](https://github.com/betaflight/betaflight/pull/10370)


##Feedforward in Level and Horizon Modes

In 4.3, feedforward now is applied to Level, Level Race, and Horizon modes.  

In Level Mode, this results in a more immediate response when moving the sticks to change the angle of the quad.  The quad should more promptly assume your new intended angle.

In Horizon Mode, while flying aggressively, the behaviour is now nearly exactly the same as acro, with all the benefits that feedforward brings in terms of immediate stick response and reduced overshoot.  It feels great!  

If you're a beginner and you find it too twitchy, reduce the feedforward value in the PIDs.

For more detail see [PR #10778](https://github.com/betaflight/betaflight/pull/10778)


## Actual Rates as the new Betaflight default

Starting from 4.3, Actual Rates will be the new Betaflight default.  See PR #10724 for graphs and more information.

`ACTUAL` rates lets you set both the target centre sensitivity and the maximum roll rate in degrees/second.  

The two values are independent of each other.  

Expo shifts the transition point between the two rates to be closer to centre (at zero) or further out (at max).

This online calculator allows visualisation of Betaflight rates vs Actual Rates.  

The new defaults are NOT exactly the same as the old Betaflight rates.  Although the max rate is the same (670 deg/s), the new defaults are softer in the centre (centre sensitivity of 70, compared to about 200 in Betaflight's old defaults), and more responsive further out.  See the [image in the pull request](https://github.com/betaflight/betaflight/pull/10724).

It is hoped that these will be easier to learn on and better suited to freestyle.  

Some experienced race pilots use 200deg/s centre sensitivity and 620 max, with no expo.  With the jitter reduction code, 200deg/s gives very quick turn-in but remains smooth and controllable in tight turns.  Others prefer lower values.

Betaflight rates users can use this [rates calculator](https://www.desmos.com/calculator/r5pkxlxhtb) to find an Actual rates equivalent to what they currently fly.  For instance, centre of 200, max 670, and expo of 0.58 results in the original default Betaflight rates curve.

If a user pastes in their Betaflight rates numbers from say a 'diff all', the `rates_type` information will not be included.  The result will be that Actual Rates will be active, but with Betaflight CLI numbers.  The quad will be un-flyable!  That's why its a bad idea to copy and paste diff all's.  Be sure to recreate your Rates manually, or, if you do a copy and paste, be sure to include the `rates_type` line from the CLI dump command when pasting your rates in.

For more detail see [PR #10724](https://github.com/betaflight/betaflight/pull/10724)


## PT2 and PT3 lowpass filtering options

In the past, the second-order Biquad filter was available as an option for gyro and D smoothing, when first-order filtering wasn't enough. Sometimes this was the case with Bosch gyros.   However, we have learned that the Biquad can oscillate with step inputs and will overshoot some inputs with frequency content near cutoff.  4.3 no longer uses the Biquad for any lowpass filtering. Biquad filtering is still an option for both gyro and D lowpass filtering for those who feel it has specific benefit there.

If your craft needed second order gyro filtering, we recommend the PT2 option, which works much the same as stacked PT1 filters, but with the cutoff adjusted to be correct. The PT2 filtering option provides less delay than the equivalent Biquad filter, though a bit less filtering, and is recommended to be used instead of the Biquad filter. PT3 filtering provides more filtering and delay than the equivalent Biquad filter and is not normally needed for gyro or D filtering.  

Compared to a PT1, filter delay increases by about 60% with a PT2 and doubles with a PT3.

For more detail see [PR #10727](https://github.com/betaflight/betaflight/pull/10727)


## CrossfireV3 and Ghost RC link improvements
(*not merged yet*)

4.3 has a fully float based internal RC data path, resulting in no aliasing or loss of resolution regardless of RC packet contents.  We also support Crossfire V3 and 11bit Ghost protocols.

We also better support very low frequency link rates - down to 16hz - by constraining the RC smoothing, and avoiding false packet timeout errors which would otherwise trash feedforward  And we support up to 1000hz links by allowing deviations to 950ns without declaring an error.

Blackbox logs now show un-smoothed rcCommand, and the RC and feedforward debugs show un-smoothed Roll setpoint and other useful data for RC link quality and resolution checking.  

## Configurator improvements

So many...

- presets
- new PID sliders
- parameters in the right places
- motor mapping and rotation widgets in the Motors tab
- warning about manually flashing the wrong target
- fixes and updates

<HR>

### Credits:
- Firmware PR management - Mikeller
- Configurator and Blackbox management - McGiverGim, Haslinghuis, Blckmn, Limon, Asizon, Mikeller
- Presets - Limon, Mikeller
- Sliders - Haslinghuis, UAVTech/spatzengr, IllusionFPV, Asizon, ctzsnooze
- Looptime, scheduler, DMA, Gyro EXTI, improved logging and OSD efficiency - Steve C Evans, many massive PR's :-)
- Multi dynamic SDFT notch - Karatebrot #10554
- RC smoothing - ctzsnooze #10629, #10650
- RPM crossfading - Karatebrot #10757
- Feedforward jitter reduction - ctzsnooze #10670
- Feedforward smoothing - ctzsnooze - #10164
- Antigravity - ctzsnooze #10163
- Expo on Gyro LPF - IllusionFPV #10239
- Linear and Dynamic mixer options - TylerCorleone, BorisB #10370 
- Dynamic idle improvements - ctzsnooze #10294
- Configurator brilliance - Haslinghuis, McGiverGim, Asizon
- LUA Script - klutvott123, kristjanbjarni, codecae
- Feedforward in level and horizon - ctzsnooze #10778
- PT2 and PT2 lowpass filter options - ctzsnooze #10727
- RC Link improvements - TBS #10675, Stepan Dalecky #10801
- default to Actual rates - ctzsnooze #10724
- Bugfixes - lots of people!
- Keeping everyone and everything on track - blckmn, mikeller
- Encouragement and testing - Brian White, James, SugarK, Cory Ibanez, Tehllama42, SupaflyFPV, UAVTech, QuadMcFly, Limon, bizmar, and so many others : thank you!
