# Betaflight 4.0 introduces:

- [RPM controlled multiple dynamic notch filtering over bi-directional DShot](https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter), to markedly improve motor noise suppression, reducing filter delay time
- [Launch Control](https://github.com/betaflight/betaflight/wiki/Launch-Control), allows a pilot to hold a specified angle precisely and accurately for the perfect race launch
- [D_min](https://github.com/betaflight/betaflight/wiki/d_min), which dynamically adjusts the PID D parameter according to stick movement
- [Dynamic lowpass filtering](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Dynamic-lowpass-filtering), to improve noise control at low rpm and reduce filter delay time at high rpm
- [Improved dynamic notch code](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Improved-dynamic-notch-code), with better tracking and better noise rejection with less delay,
- [D-only TPA](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#d-only-tpa), to selectively reduce D related noise at high throttle and maintain normal P responsiveness
- [Integrated yaw](https://github.com/betaflight/betaflight/wiki/Integrated-Yaw), and experimental option which mathematically integrates the yaw PID values, potentially simplifying yaw tuning
- [Improved setpoint mode iterm_relax](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Improved-setpoint-mode-iterm_relax), intended to improve turn accuracy during spirals and slaloms - for racers
- [Transient throttle limit](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Transient-throttle-limit), which improves noise behaviour at low and high throttle by preventing refected noise from doubling up and becoming distorted


Other flight-related changes include:

- absolute control has been improved and is now enabled by default, at a value of 10, 
- the classical dynamic notch code has been improved to better track motor noise,
- this dynamic notch is now two closely spaced narrower notches, which provides better noise suppression without significant additional delay
- iterm_rotation is disabled by default, 
- PID defaults have been changed a little.

# IMPORTANT NOTE :  SET 4.0 up from scratch!  DO NOT PASTE OLD DUMPS INTO THE CLI!

##What should I notice if I fly defaults?

- Cooler motors
- Similar propwash at low rpm, improved propwash control when throttle is maintained through turns
- A wider tuning envelope across a range of different types of quads.  
- Greater precision and a 'smoother' feel and sound to the motors

##I'm a freestyle pilot, what should I paste into the CLI?

The goal is smoothness.  Using your old PID's is fine, set D_MIN to about 75% of your previous D value, or if starting from defaults, try:
```
set feedforward_transition = 30
set iterm_relax_type = gyro
set iterm_relax_cutoff = 20
set transient_throttle_limit = 15
set i_pitch = 85
set i_roll = 80
set d_min_roll = 25
set d_min_pitch = 28
set d_pitch = 38
set d_roll = 30
set d_min_advance = 80
set tpa_rate = 50
set tpa_breakpoint = 1500
set tpa_mode = D
set p_yaw = 35
set i_yaw = 100
set d_yaw = 0
set f_yaw = 35
```

##I'm more of a race pilot... 
Here the goal is responsiveness, lots of I, and the least D possible, with propwash and flip control of lesser importance.
```
set feedforward_transition = 0
set iterm_relax_type = setpoint
set iterm_relax_cutoff = 35
set transient_throttle_limit = 10
set i_pitch = 95
set i_roll = 90
set d_min_roll = 16
set d_min_pitch = 18
set d_pitch = 28
set d_roll = 30
set d_min_advance = 80
set tpa_rate = 75
set tpa_breakpoint = 1400
set tpa_mode = D
set p_yaw = 30
set i_yaw = 90
set d_yaw = 0
set f_yaw = 30
```
#Dynamic lowpass filtering

Stick inputs for a quadcopter, and the required motor responses, all happen at low frequencies, typically less than 50 times a second (50hz).  However the noise generated by the motors extends well above 500Hz, and can be 'louder' than our stick inputs.  This noise is detected by the gyros, amplified by the PIDs, and fed back to the motors.  Since the motors cannot spin as quickly as this, the electricity going backwards and forwards from that noise doesn't generate thrust, but does generate heat.  The goal with filtering is to remove that noise to keep the motors focused only on responding to real inputs, not random noise.

All filters induce some delay, and the greater the delay, the greater the tendency for the quad to oscillate, making propwash worse and dulling handling.

The challenge with filtering is to remove as much noise as possible above the cutoff frequency, retain as much signal as possible below the cutoff frequency, and cause the least delay.

Most noise arises directly from the rotation of each motor, at the fundamental frequency of the motor (rpm * 60 in hz) and integral multiples of that frequency.  Using bi-directional DShot, BLHeli32 ESC, and the settings as per the wiki article, the betaflight rpm filter targets individual motor noise peaks with very narrow notch filters that dynamically move to sit precisely and exactly on the first three noise peaks for each motor, and track the motors very exactly.  This system  reduces motor induced noise, so that only one simple lowpass on D is usually all that's needed.  This results in about half to two-thirds the filter delay of 'standard' filtering.  More information is available [here](https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter).

For those of us who can't use rpm filtering, the classic lowpass filters have been improved in Betaflight 4.0 by providing a means to shift their filter setpoint to a higher value at full throttle, compared to low throttle.  This reduces delay at higher throttle, and better allows the dynamic notch to track the motor peak.  Delay is reduced and noise control is typically improved at high throttle.  

At low throttle the dynamic notch can now go lower than before, to assist with removal of fundamental motor oscillations that sometimes cause jello on freestyle quads.  This means that delay, and propwash, may be no better or worse than 3.4, but noise suppression across the board will be signficiantly improved.

The dynamic lowpass filter min and max values are configured independently of the classical fixed gyro lowpass 1 and 2 filters.  They become active - and the classical static lowpass 1 values are ignored - when the dynamic minimum is greater than the maximum, or when the dynamic minimum is zero.

The dynamic lowpass minimum sets the lowest frequency that the dynamic lowpass will go to.  It doesn't shift the throttle to cutoff curve upwards, rather it puts a 'floor' below which the cutoff cannot go as rpm falls.  

They dynamic lowpass maximum, eg `dyn_lpf_gyro_max_hz`, sets the highest frequency the lowpass can rise to, and defines a smooth curve from zero throttle to that value.  Ideally the dyn_lpf_gyro_max_hz should be set close to the quad's actual max rpm in hz.  For a typical 5" this is equivalent to about 450-500hz.  Smaller props typically rev faster, eg 600-650hz, and larger quads rev slower, eg 300-350hz.  Max frequency can be determined by displaying an rpm debug in the OSD as you fly, or making a log and performing blackbox or plasmatree analysis.  

The dynamic lowpass movement is intended to optimise the FFT algorithm that tracks the motor peaks.  If the lowpass doesn't go high enough on full throttle, the motor peak gets attenuated by the lowpass and the dynamic notch FFT can't track properly, which makes for worse noise overall.  Likewise if the lowpass doesn't go low enough, the FFT may jump up to the first harmonic, leaving a large fundamantal frequency to get through.  Logging with `set debug_mode = DEBUG_DYN_LPF` will log the centre frequency of the dynamic notch into debug 0.  You should see this trace tracking the motor frequency from low to high, without going too high at low rpm or dropping low at high rpm.  

Betaflight 4.0 uses a single dynamic biquad lowpass on gyro, rather than the two fixed PT1's of 3.5, because the biquad has a cleaner pass-band and much steeper cut above the cutoff point.  Delay is about the same at low rpm but less above mid rpm.  The default settings pass a lot more gyro data through below cutoff than in 3.5, leading to sharper responses generally.

We filter D quite hard, with a dynamic biquad lowpass and a second fixed static lowpass higher up.  This is to strongly suppress D noise, since D acts as a frequency dependent noise amplifier.  The arrangement was chosen to maximise D at propwash frequencies around 40-80hz and attenuate D hard above that point.  This provides the cool motors seen with betaflight 4.0.  The second static D filter doesn't absolutely have to be a biquad, a PT1 works well if the quad is fairly clean, and has less delay.  The first dynamic filter should be left as a biquad.

The dynamic lowpasses are not trivial to tune.  A blackbox log in `set debug_mode = FFT_FREQ` mode is the only practical way.  In principle for use with the standard notch filter:

- set dyn_lpf_gyro_max_hz to your approximate maximum motor rpm expressed in hz
- set dyn_lpf_gyro_min_hz no higher than 200hz in practice, depending on motor temps at low throttle
- if motors are warm and bearings not so good, add at least a second static PT1 filter on gyro
- always retain the dynamic biquad on D, and only cautiously move the minimum higher, or you may suddenly get very hot motors if the D cut point is high enough allows prop resonance through
- the second biquad on D is very useful; only move it higher if a log shows not much D noise up high.

In practice just stick with the defaults; if the motors are all cool, bring all filters up by about the same percentage, leaving the dynamic maximum for gyro always around the max rpm.  For most 5" 4S quads on 2600kv motors, that means about 500hz, for 4" on 3500kv 4S it may be 600-650hz.  7" or bigger would be lower frequencies.  


#Improved dynamic notch code

The FFT based dynamic notch we've been using cannot track every motor individually.  The FFT algorithm gives us only one single notch frequency to suppress, even if the motors diverge and make noise on multiple slightly different frequencies.  The 3.5 dynamic notch had a Q factor of 0.7 (70 in CLI), which was very wide, resulting in significant filter delay when low.  

During the 4.0 development period we found that two, closely spaced, narrower notches, would achieve better noise results with less delay, than one single wider notch.  

The value `dyn_notch_width_percent` sets how far apart, in percentage either side of the centre frequency, these paired notches will be.  The `dyn_notch_q` factor of 120 sets them to almost half the width of the dynamic notch in 3.5.  

For clean quads, or where filter delay is critical, setting `dyn_notch_width_percent` to 0 runs only one single narrow notch.  Motor temperatures are likely to be higher, but filter delay, and probably propwash, will be less.  This is not recommended for normal quads but can be helpful on high performance machines that are flown smoothly with clean props.  Another approach for clean quads flown smoothly is to narrow the percentage width and increase the Q factor.  For instance, setting width to 4% and Q to 200 results in a very narrow notch with much less delay.

Conversely if the quad is to be flown aggressively with motor speeds all over the place, and if it is noisy, the width percentage can be increased and the Q factor reduced.  Any changes should be proportional, eg if the width is increased by a factor of 50%, the Q factor should be 50% lower also, to avoid a big 'gap in the middle' between the pair of notches. 

4.0 provides a `dyn_notch_min_hz` value below which the dynamic notch cannot go.  This can be set higher than default, reducing delay and improving propwash, although the quad may get hotter motors from greater lower rpm noise.

When the dynamic notch follows an rpm peak to very low frequencies, the delay gets quite large.  Some freestyle quads get significant resonant peaks at relatively low frequencies, causing jello.  It can be useful on these quads to allow the dynamic notch to run relatively low even if it may cause significant low rpm filter delay and worsen propwash.

The 3.4 dynamic notch was a single Q=0.7 notch that moved in a relatively frequency band between about 220hz and 300hz.  The 4.0 notch can be similarly configured if desired, but it won't work nearly as well as a properly configured dynamic notch in 4.0.

Tuning the dynamic notch is best done with the aid of logging and some considerable thought.


# D Only TPA

Throttle PID Attenuation (TPA) has been around a long time.  It attenuates the PIDs linearly start at the threshold throttle value, reaching the set percentage attenuation at full throttle.  The original purpose was to reduce wobble on full throttle in highly tuned quads.  I was removed from TPA around 2.9, and since then TPA operated on both P and D.  In 3.5, D was split into D and FF, and we then started wondering about what TPA should do to those individual factors.  We noted that D mediated noise was often much worse at high throttle, and, a bit to our surprise, that we could cut D as much as 70-80% D cut on full throttle without P wobbles.  By not attenuating P or FF with throttle, TPA on D alone maintain stick responsiveness at high throttle, and markedly reduce full throttle noise and motor heat.  

Hence, TPA has been configured by default to be active only on D in 4.0.  To return TPA to classic P and D attenuation, as in 3.5 and earlier, paste into the CLI:

```
set tpa_mode = PD
```

Typically a freestyle quad might use less 'TPA on D' and a race quad say 75% from 1400.


# Improved setpoint mode iterm_relax

Iterm_relax cuts the rate of growth of I during very fast moves, to minimise I related bounce-back or overshoot after fast inputs.  If high I values are used on pitch and roll to enhance stability on windy days, some kind of iterm_relax is essential.

The setpoint (race oriented) type of iterm_relax has been changed to better hold the set radius in tight spiral turns or slaloms.  The code has has been slightly changed so that only really fast stick inputs attenuate I.  This means I can accumulate faster and more strongly during tighter turns.  

The iterm_relax_cutoff frequency determines how quickly the relax will start, and how quickly it will unwind.  For racing I recommend `set iterm_relax_cutoff = 35`.  This allows quicker I accumulation, with faster release, in tight turns.  The downside is that there may be some I mediated overshoot with flips and rolls, but that's not usually an issue in typical racing flights.

The more freestyle / LOS oriented `GYRO` type of iterm_relax has not changed.   iterm_relax_cutoff should be left at 20hz in this mode.  Gyro type iterm_relax strongly attenuates iterm accumulation during most stick inputs, leading to very clean flips and rolls.  It isn't ideal for racing or very tight spiral turns around flags or gates because there is a certain point where I comes on and off, and if that matches the stick input rate of a turn, the quad will vary its turn radius a lot more than expected for a given input.  Typically this is only an issue with high speed tight racing turns.


#Transient throttle limit

When airmode is active, if any single motor trace would exceed either 0 or 100%, airmode will automatically adjust throttle to maintain motor differential.  For example, if the flight controller required a 40% motor differential to make a turn, but one motor would, as a result, go 10% below zero, throttle will be increased by 10%.  This is how air mode retains normal responsiveness at very low or very high throttle.  

Airmode works great like that.  But, if there is are noise spikes superimposed on any one motor trace, big enough to make that motor to exceed 100%, airmode will cut the peak off at 100% and 'reflect' the chopped off spikes into the other three motors, upside down.  This causes sharp spikes on all motor signals and harsh digital clipping of the 'overshooting' motor signal.  

This is a problem at both ends of the throttle range, contributing to hot motors on full throttle, and bad grinding noises or instability on arming.

By measuring the amount of noise in the motor signals, an additional throttle lift (or cut) can be dynamically provided, only as much as needed, to stop the noise reflection problem.

There is one CLI adjustment, `transient_throttle_limit`, which sets the maxium amount of throttle boost or cut allowed in percent.  15% is quite generous and rarely needed in most quads, but there's no downside to having it this high under normal conditions.  Having it set this high may, however, help you fly home with a bent prop and not cook the motors.