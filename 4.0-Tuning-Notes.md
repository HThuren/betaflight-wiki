# Betaflight 4.0 introduces:

- [RPM controlled multiple dynamic notch filtering over bi-directional DShot](https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter), to markedly improve motor noise suppression, reducing filter delay time
- [Launch Control](https://github.com/betaflight/betaflight/wiki/Launch-Control), allows a pilot to hold a specified angle precisely and accurately for the perfect race launch
- [D_min](https://github.com/betaflight/betaflight/wiki/d_min), which dynamically adjusts the PID D parameter according to stick movement
- [Dynamic lowpass filtering](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Dynamic-lowpass-filtering), to improve noise control at low rpm and reduce filter delay time at high rpm
- [Improved dynamic notch code](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Improved-dynamic-notch-code), with better tracking and better noise rejection with less delay,
- [D-only TPA](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#d-only-tpa), to selectively reduce D related noise at high throttle and maintain normal P responsiveness
- [Integrated yaw](https://github.com/betaflight/betaflight/wiki/Integrated-Yaw), and experimental option which mathematically integrates the yaw PID values, potentially simplifying yaw tuning
- [Improved setpoint mode iterm_relax](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Improved-setpoint-mode-iterm_relax), intended to improve turn accuracy during spirals and slaloms - for racers
- [Transient throttle limit](https://github.com/betaflight/betaflight/wiki/4.0-Tuning-Notes#Transient-throttle-limit), which improves noise behaviour at low and high throttle by preventing refected noise from doubling up and becoming distorted


Other flight-related changes include:

- Absolute control has been improved and is now enabled by default, at a value of 10, 
- Dynamic notch code has been improved to better track and suppress motor noise with less delay, using two closely spaced, narrower notches
- Iterm_rotation is disabled by default, 
- PID defaults have been changed a little.

# IMPORTANT NOTE :  SET 4.0 up from scratch!  DO NOT PASTE OLD DUMPS INTO THE CLI!

##What should I notice if I fly defaults?

- Cooler motors
- Similar propwash at low rpm, improved propwash control when throttle is maintained through turns
- A wider tuning envelope across a range of different types of quads.  
- Greater precision and a 'smoother' feel and sound to the motors

##I'm a freestyle pilot, what should I paste into the CLI?

The goal is smoothness.  Using your old PID's is fine, set D_MIN to about 75% of your previous D value, or if starting from defaults, try:
```
set feedforward_transition = 30
set iterm_relax_type = gyro
set iterm_relax_cutoff = 20
set transient_throttle_limit = 15
set i_pitch = 85
set i_roll = 80
set d_min_roll = 25
set d_min_pitch = 28
set d_pitch = 38
set d_roll = 30
set d_min_advance = 80
set tpa_rate = 50
set tpa_breakpoint = 1500
set tpa_mode = D
set p_yaw = 35
set i_yaw = 100
set d_yaw = 0
set f_yaw = 35
```

##I'm more of a race pilot... 
Here the goal is responsiveness, lots of I, and the least D possible, with propwash and flip control of lesser importance.
```
set feedforward_transition = 0
set iterm_relax_type = setpoint
set iterm_relax_cutoff = 35
set transient_throttle_limit = 10
set i_pitch = 95
set i_roll = 90
set d_min_roll = 16
set d_min_pitch = 18
set d_pitch = 28
set d_roll = 30
set d_min_advance = 80
set tpa_rate = 75
set tpa_breakpoint = 1400
set tpa_mode = D
set p_yaw = 30
set i_yaw = 90
set d_yaw = 0
set f_yaw = 30
```
## Dynamic lowpass filtering

### Introduction

Stick inputs for a quadcopter, and the required motor responses, all happen at low frequencies, typically less than 50 times a second (50hz).  However the noise generated by the motors extends well above 500Hz, and can be 'louder' than our stick inputs.  This noise is detected by the gyros, amplified by the PIDs, D in particular, and fed back to the motors.  Since the motors cannot spin as quickly as the noise frequencies, the electricity going backwards and forwards from noise just generates heat.  The goal with filtering is to remove the noise and ensure the motors are sent only noise-free clean inputs.

All filters induce some delay, and the greater the delay, the greater the tendency for the quad to oscillate in propwash worse and dulling handling.

The challenge with filtering is to remove as much noise as possible above the cutoff frequency, retain as much signal as possible below the cutoff frequency, and cause the least delay.  But all filters add delay, and the stronger the filtering, the greater the delay.

Most noise arises from the rotation of each motor, which shakes the frame a little bit every rotation.  This generates an rpm-dependent noise signal at the fundamental frequency of the motor (rpm * 60 in hz), and secondary  integral multiples of that frequency (harmonics).  All propeller blades also have natural resonant frequencies, and can abruptly and suddenly generate bad oscillations at their resonant frequency when it matches the motor rotation frequency.  All this noise is directly related to motor rpm.  Although there is some non-rpm related broad band random noise from air turbulence and bearing rattle, the vast majority of the noise is directly rpm related. 

Using bi-directional DShot, and a BLHeli32 ESC with suitable code, the new [betaflight rpm notch filters](https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter) identify the fundamental and harmonic frequencies of every motor, and target the related noise peaks with very narrow notch filters that almost totally remove motor-frequency-related noise.  Usually only one simple lowpass on D is all that's needed to clean up the remaining random non-rpm dependent noise.  This results in about half to two-thirds the filter delay of 'standard' filtering.  

For those of us who can't use rpm filtering, the dynamic notch and the lowpass filtering have been improved so that both work better and with less delay.

### Changes to noise filtering in 4.0

Betaflight 4.0 now provides a means to smoothly shift the lowpass filter cutoff to a higher value at full throttle, compared to low throttle.  The cutoff frequency assigned to the first gyro and D lowpass filter now dynamically increases, with increasing throttle, along a curve that effectively emulates motor rpm.  This reduces delay at higher throttle, and allows the dynamic notch to better track the motor peak.  

At low throttle the dynamic notch can now go lower than before, to assist with removal of fundamental motor oscillations that sometimes cause jello on freestyle quads.  The new dynamic lowpass defaults let the dynamic notch can now track motor noise more precisely and over a wider range of frequencies, and clean up noise above the motor fundamental frequency much more cleanly than before.

Delay, and propwash, may be no better than 3.4 at low rpm, but typically is significantly improved at higher rpm.  Noise suppression across the board will be signficiantly improved.

### Enabling / disabling dynamic lowpass filtering

The dynamic lowpass filter min and max values are configured independently of the classical static gyro lowpass 1 value.  When active, the dynamic lowpass filter settings override the value of the static lowpass 1 filter.  The static lowpass 2 filter, and the static notch filters, remain available and work as before.

Not all boards have the flash size to support dynamic lowpass filtering; if your board doesn't show CLI entries for `dyn_lpf_gyro_min_hz` and the like, it's not supported.

Dynamic lowpass filtering becomes active, and the static lowpass 1 value is ignored, when the dynamic maximum is greater than the dynamic minimum, and when the dynamic minimum is greater than zero.

For example, these settings will ignore the value in `gyro_lowpass_hz` and enable dynamic lowpass filtering with a minimum of 150 and maximum of 600hz:
```
set dyn_lpf_gyro_min_hz = 150
set dyn_lpf_gyro_max_hz = 600
```
The following will disable dynamic lowpass filtering and return the quad to a static lowpass at whatever value is set in `gyro_lowpass_hz`:
```
set dyn_lpf_gyro_min_hz = 150
set dyn_lpf_gyro_max_hz = 0
```

Dynamic lowpass filtering works best when configured as a biquad.  That single dynamic biquad will provide all the filtering done previously by both static PT1's of 3.5.  Typically static secondary gyro lowpass 2 filter, and no static notches, are required.  It is strongly recommended to use defaults for the lowpass filtering in 4.0.

### Dynamic lowpass filter settings

`dyn_lpf_gyro_min_hz ` sets the lowest frequency below which the dynamic lowpass filter cannot pass.  It doesn't shift the throttle to cutoff curve upwards, rather it puts a 'floor' below which the cutoff cannot go as rpm falls.  

`dyn_lpf_gyro_max_hz`, sets the highest frequency the lowpass can rise to, following a smooth curve from zero throttle.  Ideally `dyn_lpf_gyro_max_hz` should be set close to the quad's actual max rpm in hz.  For a typical 5" this is about 450-500hz, equivalent to 27,000 to 30,000 rpm.  Smaller props typically rev faster, eg 600-650hz for 3"-4", and larger quads rev slower, eg 300-350hz.  Max frequency can be determined by displaying an rpm debug in the OSD as you fly, or making a log and performing blackbox or plasmatree analysis.  

If, on full throttle, the dynamic lowpass doesn't go high enough, it attenuates the motor peak so much that the dynamic notch FFT can't track the motor peak properly, which makes for worse noise overall.  Likewise if the lowpass doesn't go low enough, the FFT may jump up to the first harmonic, leaving a large fundamantal frequency to get through.  Logging with `set debug_mode = DEBUG_DYN_LPF` will show the centre frequency of the FFT that drives the dynamic notch (recorded into debug 0).  The FFT value should smoothly track the motor frequency from low to high.  If the FFT cannot stay stable on the high throttle motor peak, dyn_lpf_gyro_max_hz might be able to go a bit higher.  If the FFT jumps around a lot at low throttle, you can help it track the primary motor peak better by adjusting dyn_lpf_gyro_min_hz.
 
Betaflight 4.0 uses a single dynamic biquad lowpass on gyro by default, rather than the two fixed PT1's of 3.5, because the biquad has a cleaner pass-band and much steeper cut above the cutoff point.  It very effectively attenuates all noise above the anticipated motor peak, and allows the dynamic notch to remove that.  The end result should be very clean noise spectrum, with the fundamental motor peak, the harmonics, and most ordinary noise removed.  Delay is about the same as 3.5 at low rpm but reduced above mid rpm.  The default settings pass a lot more gyro data through below cutoff than in 3.5, leading to sharper responses generally, but particularly so at higher rpm.

### Dynamic D filtering

The same dynamic approach is used on D, but in a slightly different way.

D actively amplifies higher frequency noise, but we need as much D as possible to help control un-commanded events like overshoot and propwash.  Propwash happens in a range around 30-80hz on a well-tuned quad.  So we need as much D as possible up to 100hz, and as little as possible above that.  At the same time, delay on D really reduces its effectiveness, so we want the least D delay possible.  This is almost an impossible challenge!

After extensive emulation we found that the default 4.0 biquad dynamic lowpass settings provide the best outcome.  We filter D quite hard, with a dynamic biquad lowpass ranging from 150 - 250hz, and a second fixed static lowpass higher up at 250hz.  This setup maximises D at propwash frequencies around 40-80hz and attenuates D hard above that point.  This is the main reason for the cool motors seen with betaflight 4.0, despite functionally less gyro filtering.  The second static D filter doesn't absolutely have to be a biquad, a PT1 works well and is preferred if the quad is fairly clean and there's not a lot of high frequency D noise.  

The first dynamic D lowpass filter should always be left as a biquad.

Tuning the dynamic lowpasses is not trivial.  A blackbox log in `set debug_mode = FFT_FREQ` mode is the only practical way.  In principle:

- set dyn_lpf_gyro_max_hz to your approximate maximum motor rpm expressed in hz
- set dyn_lpf_gyro_min_hz no higher than 200hz in practice, varying it up and down depending on motor temps at low throttle
- if motors are warm and bearings not so good, add a static PT1 filter on gyro
- always retain the dynamic biquad on D, and only cautiously move the minimum higher, or you may suddenly get very hot motors if the D cut point is high enough that it cannot control prop resonance
- the second static lowpass on D is very useful; only move it higher if a log shows not much D noise up high.

In practice just stick with the defaults; if the motors are cool, bring all filters up by about the same percentage, leaving the dynamic maximum for gyro always around the max rpm.  


## Improved dynamic notch code

The FFT based dynamic notch we've been using cannot track every motor individually.  The FFT algorithm gives us only one single notch frequency to suppress, even if the motors diverge and make noise on multiple slightly different frequencies.  The 3.5 dynamic notch had a Q factor of 0.7 (70 in CLI), which was very wide, resulting in significant filter delay when low.  

During the 4.0 development period we found that two, closely spaced, narrower notches, would achieve better noise results with less delay, than one single wider notch.  

The value `dyn_notch_width_percent` sets how far apart, in percentage either side of the centre frequency, these paired notches will be.  The `dyn_notch_q` factor of 120 sets them to almost half the width of the dynamic notch in 3.5.  

For clean quads, or where filter delay is critical, setting `dyn_notch_width_percent` to 0 runs only one single narrow notch.  Motor temperatures are likely to be higher, but filter delay, and probably propwash, will be less.  This is not recommended for normal quads but can be helpful on high performance machines that are flown smoothly with clean props.  Another approach for clean quads flown smoothly is to narrow the percentage width and increase the Q factor.  For instance, setting width to 4% and Q to 200 results in a very narrow notch with much less delay.

Conversely if the quad is to be flown aggressively with motor speeds all over the place, and if it is noisy, the width percentage can be increased and the Q factor reduced.  Any changes should be proportional, eg if the width is increased by a factor of 50%, the Q factor should be 50% lower also, to avoid a big 'gap in the middle' between the pair of notches. 

4.0 provides a `dyn_notch_min_hz` value below which the dynamic notch cannot go.  This can be set higher than default, reducing delay and improving propwash, although the quad may get hotter motors from greater lower rpm noise.

When the dynamic notch follows an rpm peak to very low frequencies, the delay gets quite large.  Some freestyle quads get significant resonant peaks at relatively low frequencies, causing jello.  It can be useful on these quads to allow the dynamic notch to run relatively low even if it may cause significant low rpm filter delay and worsen propwash.

The 3.4 dynamic notch was a single Q=0.7 notch that moved in a relatively frequency band between about 220hz and 300hz.  The 4.0 notch can be similarly configured if desired, but it won't work nearly as well as a properly configured dynamic notch in 4.0.

Tuning the dynamic notch is best done with the aid of logging and some considerable thought.


## D Only TPA

Throttle PID Attenuation (TPA) has been around a long time.  It attenuates the PIDs linearly start at the threshold throttle value, reaching the set percentage attenuation at full throttle.  The original purpose was to reduce wobble on full throttle in highly tuned quads.  I was removed from TPA around 2.9, and since then TPA operated on both P and D.  In 3.5, D was split into D and FF, and we then started wondering about what TPA should do to those individual factors.  We noted that D mediated noise was often much worse at high throttle, and, a bit to our surprise, that we could cut D as much as 70-80% D cut on full throttle without P wobbles.  By not attenuating P or FF with throttle, TPA on D alone maintain stick responsiveness at high throttle, and markedly reduce full throttle noise and motor heat.  

Hence, TPA has been configured by default to be active only on D in 4.0.  To return TPA to classic P and D attenuation, as in 3.5 and earlier, paste into the CLI:

```
set tpa_mode = PD
```

Typically a freestyle quad might use less 'TPA on D' and a race quad say 75% from 1400.


## Improved setpoint mode iterm_relax

Iterm_relax cuts the rate of growth of I during very fast moves, to minimise I related bounce-back or overshoot after fast inputs.  If high I values are used on pitch and roll to enhance stability on windy days, some kind of iterm_relax is essential.

The setpoint (race oriented) type of iterm_relax has been changed to better hold the set radius in tight spiral turns or slaloms.  The code has has been slightly changed so that only really fast stick inputs attenuate I.  This means I can accumulate faster and more strongly during tighter turns.  

The iterm_relax_cutoff frequency determines how quickly the relax will start, and how quickly it will unwind.  For racing I recommend `set iterm_relax_cutoff = 35`.  This allows quicker I accumulation, with faster release, in tight turns.  The downside is that there may be some I mediated overshoot with flips and rolls, but that's not usually an issue in typical racing flights.

The more freestyle / LOS oriented `GYRO` type of iterm_relax has not changed.   iterm_relax_cutoff should be left at 20hz in this mode.  Gyro type iterm_relax strongly attenuates iterm accumulation during most stick inputs, leading to very clean flips and rolls.  It isn't ideal for racing or very tight spiral turns around flags or gates because there is a certain point where I comes on and off, and if that matches the stick input rate of a turn, the quad will vary its turn radius a lot more than expected for a given input.  Typically this is only an issue with high speed tight racing turns.


## Transient throttle limit

When airmode is active, if any single motor trace would exceed either 0 or 100%, airmode will automatically adjust throttle to maintain motor differential.  For example, if the flight controller required a 40% motor differential to make a turn, but one motor would, as a result, go 10% below zero, throttle will be increased by 10%.  This is how air mode retains normal responsiveness at very low or very high throttle.  

Airmode works great like that.  But, if there is are noise spikes superimposed on any one motor trace, big enough to make that motor to exceed 100%, airmode will cut the peak off at 100% and 'reflect' the chopped off spikes into the other three motors, upside down.  This causes sharp spikes on all motor signals and harsh digital clipping of the 'overshooting' motor signal.  

This is a problem at both ends of the throttle range, contributing to hot motors on full throttle, and bad grinding noises or instability on arming.

By measuring the amount of noise in the motor signals, an additional throttle lift (or cut) can be dynamically provided, only as much as needed, to stop the noise reflection problem.

There is one CLI adjustment, `transient_throttle_limit`, which sets the maxium amount of throttle boost or cut allowed in percent.  15% is quite generous and rarely needed in most quads, but there's no downside to having it this high under normal conditions.  Having it set this high may, however, help you fly home with a bent prop and not cook the motors.

## THANK YOU to all the amazing ideas people, testers and programmers who helped make this release so amazing!