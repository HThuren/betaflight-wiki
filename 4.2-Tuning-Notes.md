# Betaflight 4.2 introduces... 

- [More accurate loop times](4.2-Tuning-Notes#More-accurate-loop-times)
- [Improved feed forward](4.2-Tuning-Notes#Improved-Feed-Forward)
- [Improved dynamic notch filter](4.2-Tuning-Notes#Improved-dynamic-notch-filter)
- [Simpler and better RC smoothing](4.2-Tuning-Notes#RC-smoothing-improvements)
- [Dynamic D filter expo curve](4.2-Tuning-Notes#Dynamic-D-filtering-expo)
- [Configurator improvements](4.2-Tuning-Notes#Configurator-improvements)

Betaflight 4.2 includes a number of improvements and updates to flight performance and code efficiency.  Most users will find that there is a bit less jitter and a smoother feel overall.  There are no major changes to PIDs or defaults.  If you're new to 4.2, please read the 4.0 and 4.1 tuning notes for features that haven't changed.

Please use the latest [Betaflight Configurator](https://github.com/betaflight/betaflight-configurator) with 4.2.  A [nightly build](https://github.com/betaflight/betaflight-configurator-nightlies/releases) is also available.

### NOTE 1: DO NOT paste in a diff or dump from any build before 4.1** into the 4.2 CLI.  A 4.1 `diff all` should be OK.  

### NOTE 2: If you're new to 4.2, please start with stock filters and PIDs, unless you know for sure that your quad really needs something unusual. 

As before, we strongly recommend enabling RPM based filtering.  4.2's stronger PID loop timing accuracy has markedly improved rpm filter precision.  Read about [enabling and configuring rpm filtering here.](https://github.com/betaflight/betaflight/wiki/Bidirectional-DSHOT-and-RPM-Filter)

## More accurate loop times

The basic gyro and PID loop scheduling has been completely rewritten, resulting in much less PID loop jitter.  Most users should see reduced CPU utilisation and more stable looptimes.  No special configuration is required; it just works.

An accurately clocked PID loop significantly improves filter accuracy, which provides particular benefits to RPM and dynamic notch filtering.  This should lead to cooler motors and smoother flight, especially when CPU usage had been high (eg F411 boards).  

In 4.2, the gyro is always sampled at the 'native' gyro rate.  Only gyro lowpass 2 runs at gyro loop rate; everything else at PID loop rate.  There is no longer a need to set the gyro loop rate.  The PID loop rate can still be set to suit the capabilities of the processor.  F405 and F7xx boards should be fine with 8k PID loops, but F411's should be set to 4k.

Previously, when an 8k4k or 8k2k setup was used, downsampling from the gyro to PID loop caused aliasing noise.  Not a lot, but some.  Now, the gyro lowpass 2 filter, if configured, acts as a very effective anti-aliasing filter.  If gyro lowpass 2 is disabled, a simple 2-point averaging filter is automatically activated.  This requires less CPU and causes very little delay, but isn't quite so effective.  If you plan on only running one (fixed) gyro lowpass filter, make it lowpass 2.  If gyro lowpass 1 is active, and the quad is so clean that you are considering disabling lowpass 2, first set it to 1000hz, before trying with it off altogether.

## Improved Feed Forward

4.2 improves the ability of Feed Forward to react smoothly when faced with glitches in the incoming RC signal, and provides more configuration options, allowing optimisation to suit everything from hard-core racing to cinematic HD.

When configured aggressively, Feed Forward reacts immediately to any stick input.  The basic feed forward component is proportional to the speed with which the sticks move, and the boost component is proportional to the instantaneous acceleration of the sticks.  When tuned effectively, aggressive feed forward can reduce setpoint to gyro delay to effectively zero.

The primary downside of aggressive feed forward is jitter.  Most radios have some jitter in their signal, and many will drop packets or send duplicate packets.  If the quad is configured to react immediately to the tiniest input, the quad may 'tremble' or just be a little bit nervous in what should be smooth forward flight or smooth gentle long radius turns.

The needs of the race pilot differ greatly from those of a person wanting super smooth HD footage, hence in 4.2 we've put a lot of thought into how best address these differing requirements, and into effective smooth glitch reduction.

Feed forward depends greatly on the stability of the RC link, and the smoothness of the steps between incoming packets.  We strongly recommend Crossfire users to move to the latest software (including the update to OpenTx to provide external module sync) and for FrSky users to upgrade to OpenTx 2.3 and disable ADC.

### Mode: ff_interpolated_sp

The most important feed forward parameter is the 'mode' in which feed forward operates, which can be set as follows using the `set ff_interpolated_sp` command in the CLI as follows:

- `OFF`: the older linear interpolation method, with no boost or glitch reduction
- `ON`: the newer setpoint based interpolation mode, with immediate response to every change in RC, with boost and glitch reduction, intended for racing
- `AVERAGED_2`: as above, but with two point moving averaging for glitch reduction and for elimination of alternating up/down FF jitter, but with reduced jitter when flying straight ahead or in smooth arcs.  For general purpose use, including racing and modern freestyle (default)
- `AVERAGED_3`: three point moving average glitch reduction, providing strong jitter reduction in smooth arcs or when flying straight ahead.  Intended for freestyle with HD cameras. Effectively reduces 3-step (20ms) jitter in locked 150hz Crossfire setups that haven't been upgraded to external module sync code.
- `AVERAGED_4`: four point moving average smoothing and strongest jitter reduction, best for smooth cinematic HD recordings.  Can also be effective in smoothing jittery R9 traces.

### Smoothness: ff_smooth_factor

Next most important is the 'smoothness' factor, which limits the amount of change that any one incoming radio step can make.  It acts like an exponential or lowpass type smoothing function.  The cli parameter is `ff_smooth_factor`.  Default is 37, max is 75.

With`set ff_smooth_factor = 0`, there is no smoothing of outgoing FF steps.  The full FF and boost amount for any given incoming RC step will be applied immediately.  This is probably what a racer with a clean radio setup would prefer.  

At the default of 37, 63% of the incoming feed forward step will be applied immediately.  The response is like a first order lowpass filter with a time constant of one RC interval (cutoff of 1000/2*pi*RCinterval Hz, or about 24hz for 6.66ms RC steps).  This parameter smooths out sharp steps in the FF signal, reducing some of the jitter component that is common with many radios.

Values above default will provide a smoother FF signal, but may cause so much delay as to make feed forward a bit useless.  Not recommended except on perhaps slow cinematic HD rigs.

### Boost: ff_boost

This hasn't changed since 4.1; please read the [4.1 tuning notes](https://github.com/betaflight/betaflight/wiki/4.1-Tuning-Notes#Feed-Forward-Boost) 

To summarise, boost responds to stick acceleration, and helps overcome motor lag with quick stick inputs.  It also generates RC jitter and glitch artefact better than anything else.  The default settings in 4.2 attempt to strike a good balance.

Default boost is 15, and that works for nearly all quads.  Racers may prefer 20.  Higher values are likely to cause micro overshoots, jitter and excessive sensitivity on normal quads, but up to 30 may be useful on low authority quads.

### Spike limiting: ff_spike_limit

`ff_spike_limit` provides simple soft cliping method, to chop the tops off large FF spikes.  The default should be acceptable for most radios.  Most people should leave this value at defaults.  

Higher numbers will allow progressively bigger spikes through.  Racers or people with clean radios who want full feed forward aggression can increase this value, but should look closely at their feed forward trace to see what happens.

The biggest normal single FF step change that a pilot ever generates is when they suddenly return from full stick deflection, ie on terminating a fast flip.  If having the least possible delay at this point is important, maye try shifting the spike limit higher.  

### Overshoot limiting: ff_max_rate_limit

`ff_max_rate_limit` also hasn't changed since 4.1, please read the [4.1 tuning notes ](4.1-Tuning-Notes#Feed-Forward-Limiting).

Executive summary - leave this at 100.


## Improved Dynamic Notch filter

The dynamic notch filter has been extensively revised.  The code now identifies and tracks peaks more accurately, and over a wider frequency range.  Performance will be better on most quads.  It will also be more accurate with non-standard gyro rates.  

The most obvious change is that instead of choosing a range using `AUTO`, `LOW`, `MEDIUM` or `HIGH`, the user now directly sets the actual maximum value of the frequency range that they want the dynamic notch to cover, using `dyn_notch_max_hz`.   The dynamic notch will then calculate the optimal sampling rate to control noise between the minimum and maximum frequency values.

The optimal `dyn_notch_max_hz` value depends on whether or not you're using rpm filtering.  

When rpm filtering isn't being used, and in particular when gyro filtering is not covering higher frequencies, the dynamic notch needs to be able to range over the full range of possible motor generated frequencies.  The value required can be determined accurately by logging with debug GYRO_SCALED and looking at the highest frequency reported in spectral analysis.  Alternatively it can be estimated as 70% of the peak theoretical no-load rpm.  For example, a 2000KV motor with 6S has no load rpm of 2000*6*4 = 48000 rpm.  70% of that is 33,600rpm, divide by 60 and you get 560hz.

Slow fliers and X-class quads may be better off with `dyn_notch_max_hz` set to say 350-400hz, and perhaps a lower `dyn_notch_min_hz` than defaults.  Lower maximum values will improve resolution over defaults.

With rpm filtering, the motor noise lines will usually be removed completely, leaving the dynamic notch with not much to do.  In many cases it can be turned off.  However it can remain useful for attenuating residual noise or frame resonance.  If there is no particular frame resonance, it will sort of hover around the middle of its range.  With the defaults, this keeps it out of the way, causing relatively little delay.  If there is a specific resonance at some particular frequency, the min and max values can be centered either side of the resonance line.  

Note that no matter how low you set the max value, the value used internally will never be less than twice the minimum value.  This is necessary to ensure the code works properly.

The 4.1 tuning guide notes about notch width and Q factor still apply... in short, when using the rpm filter:

```
set dyn_notch_width_percent = 0
set dyn_notch_q = 250
```

And this restores the default values for use without RPM filtering
```
set dyn_notch_width_percent = 8
set dyn_notch_q = 120
```


## RC-smoothing-improvements

Following extensive testing, the default RC smoothing values were simplified and optimised.  Usually no changes from defaults are needed.  

The default auto smoothing method will dynamically calculate RC smoothing time constants from the identified RC packet intervals.  This works really well with most radio systems and with interpolated feed forward.  The default input filter type is `BIQUAD`, it smooths setpoint and P.  The derivative filter type is `PT1`, which smooths the sharp corners off the interpolated feed forward trace.

Most pilots should use the defaults.

`rc_smoothing_auto_factor` sets how 'smooth' the RC traces will be.  Higher values result in greater smoothness, but add RC delay.  10 is optimal for most general purpose flying.  Racers may prefer 8, or even 5, but will get more jumpy motor traces as a result, often not improving performance much if at all; for old jittery radios, 20 or even 40 may smooth out things a bit. 

These are the new default settings:
```
set rc_smoothing_type = FILTER
set rc_smoothing_input_hz = 0
set rc_smoothing_derivative_hz = 0
set rc_smoothing_input_type = BIQUAD
set rc_smoothing_derivative_type = PT1
set rc_smoothing_auto_factor = 10
``````

## Dynamic D filtering expo

`dyn_lpf_curve_expo` now makes the D lowpass rise more quickly with throttle increases than it otherwise would.  And expo-shaped curve is applied.  

The end-points (`dyn_lpf_dterm_min_hz` and `dyn_lpf_dterm_max_hz` remain the same, just the change up happens earlier and quicker.

Default is no change (1).  Higher values may improve propwash by reducing delay.  This can be particularly useful when low D filtering is needed at idle, but not so much is needed once the motors get going.

## Configurator changes and improvements

<to be done>

***
Credits:
Looptime and scheduler - eTracer
Interpolated setpoint  - JoeLucid and ctzsnooze
Dynamic notch - ctzsnooze 
RC smoothing - eTracer and ctzsooze
Expo on D filter - IllusionFPV
Configurator - mgvivergim, IvoFPV, Asizon
Bugfixes - eTracer, jFlyper, many many others
Keeping everyone on track - mikeller
Encouragement and testing - bizmar, iCr4sh, SugarK, BigRuss, BMSThomas, many others : thank you!